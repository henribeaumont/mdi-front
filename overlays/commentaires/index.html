<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MDI ‚Ä¢ Overlay Commentaires</title>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    :root{
      --bg:#0A0F1E;
      --panel:rgba(255,255,255,0.06);
      --border:rgba(255,255,255,0.14);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.65);
      --ok:#2ecc71;
      --bad:#ff3b30;
      --warn:#F9AD48;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:transparent; /* OBS friendly */
      font-family:var(--font);
      color:var(--text);
      overflow:hidden;
    }

    /* Anti-flicker: on cache tout tant que socket pas pr√™t */
    body.is-loading{ opacity:0; }

    .debug{
      position:fixed;
      top:14px; left:14px;
      min-width:320px;
      max-width:70vw;
      padding:10px 12px;
      border-radius:14px;
      background:var(--panel);
      border:1px solid var(--border);
      backdrop-filter: blur(10px);
      display:flex;
      gap:10px;
      align-items:flex-start;
      z-index:9999;
    }
    .dot{
      width:12px; height:12px;
      border-radius:999px;
      background:var(--bad);
      margin-top:4px;
      flex:0 0 auto;
    }
    .debug .lines{ font-size:12px; line-height:1.25; color:var(--muted); }
    .debug b{ color:var(--text); }

    .card{
      position:fixed;
      left:50%;
      bottom:90px;
      transform:translateX(-50%) translateY(14px);
      width:min(1100px, calc(100vw - 80px));
      background:rgba(10,15,30,0.78);
      border:1px solid rgba(255,255,255,0.18);
      border-radius:22px;
      padding:18px 22px;
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,0.35);
      opacity:0;
      transition: opacity .18s ease, transform .18s ease;
    }
    .card.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }

    .row{
      display:flex;
      align-items:baseline;
      gap:12px;
      margin-bottom:10px;
    }
    .tag{
      font-size:12px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.25);
      color:rgba(255,255,255,0.85);
      flex:0 0 auto;
    }
    .author{
      font-size:14px;
      font-weight:800;
      color:rgba(255,255,255,0.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:55%;
    }

    .text{
      font-size:44px;
      font-weight:900;
      line-height:1.06;
      letter-spacing:-0.02em;
      word-break:break-word;
      text-shadow:0 2px 0 rgba(0,0,0,0.2);
    }

    /* Petit rep√®re en bas √† gauche (optionnel) */
    .corner{
      position:fixed;
      left:14px;
      bottom:14px;
      font-size:11px;
      color:rgba(255,255,255,0.38);
      user-select:none;
    }
  </style>
</head>

<body class="is-loading">
  <!-- Debug overlay (tu peux le masquer plus tard) -->
  <div class="debug">
    <div id="dot" class="dot"></div>
    <div class="lines" id="dbg">
      <div><b>Overlay:</b> commentaires</div>
      <div><b>room:</b> ‚Ä¶</div>
      <div><b>key:</b> ‚Ä¶</div>
      <div><b>socket:</b> ‚Ä¶</div>
      <div><b>join:</b> ‚Ä¶</div>
      <div><b>last raw_vote:</b> ‚Ä¶</div>
    </div>
  </div>

  <!-- Carte affich√©e -->
  <div id="card" class="card">
    <div class="row">
      <span class="tag">COMMENTAIRE</span>
      <span id="author" class="author"></span>
    </div>
    <div id="text" class="text"></div>
  </div>

  <div class="corner">MDI Live ‚Ä¢ commentaires</div>

<script>
  const SERVER_URL = "https://magic-digital-impact-live.onrender.com";
  const OVERLAY_NAME = "commentaires";

  const elDot = document.getElementById("dot");
  const elDbg = document.getElementById("dbg");
  const elCard = document.getElementById("card");
  const elText = document.getElementById("text");
  const elAuthor = document.getElementById("author");

  let socket = null;
  let hideTimer = null;

  const AUTO_HIDE_MS = 8000;
  const seen = new Map();
  const DEDUPE_WINDOW_MS = 1200;

  function clean(t){
    return String(t ?? "").replace(/\u00A0/g," ").replace(/\s+/g," ").trim();
  }

  function getParam(name){
    try{
      const u = new URL(location.href);
      return clean(u.searchParams.get(name));
    }catch(e){
      return "";
    }
  }

  // ‚úÖ Lit room/key depuis l‚ÄôURL (plusieurs alias au cas o√π)
  function getRoomKey(){
    const room = getParam("room") || getParam("ID_SALLE") || getParam("id_salle") || getParam("idsalle") || "";
    const key  = getParam("key")  || getParam("ROOM_KEY") || getParam("room_key") || getParam("roomKey") || "";
    return { room: clean(room), key: clean(key) };
  }

  function setDot(ok){
    elDot.style.background = ok ? "var(--ok)" : "var(--bad)";
  }

  function setDbg(lines){
    elDbg.innerHTML = lines.map(l => `<div>${l}</div>`).join("");
  }

  function show(text, user){
    const t = clean(text);
    const u = clean(user);

    if(!t){
      hide();
      return;
    }

    elText.textContent = t;

    if(u){
      elAuthor.textContent = u;
      elAuthor.style.display = "";
    }else{
      elAuthor.textContent = "";
      elAuthor.style.display = "none";
    }

    elCard.classList.add("show");
    if(hideTimer) clearTimeout(hideTimer);
    hideTimer = setTimeout(hide, AUTO_HIDE_MS);
  }

  function hide(){
    elCard.classList.remove("show");
    if(hideTimer){
      clearTimeout(hideTimer);
      hideTimer = null;
    }
  }

  function pruneSeen(now){
    for(const [k, ts] of seen.entries()){
      if(now - ts > DEDUPE_WINDOW_MS) seen.delete(k);
    }
  }

  function connect(){
    const { room, key } = getRoomKey();

    setDbg([
      "<b>Overlay:</b> commentaires",
      `<b>room:</b> ${room || "‚ùå (manquant)"}`,
      `<b>key:</b> ${key ? "‚úÖ (pr√©sent)" : "‚ùå (manquant)"}`,
      "<b>socket:</b> connexion‚Ä¶",
      "<b>join:</b> ‚Äî",
      "<b>last raw_vote:</b> ‚Äî",
    ]);

    socket = io(SERVER_URL, { transports: ["websocket","polling"] });

    socket.on("connect", () => {
      setDot(true);

      // üî• join AVEC key
      if(room && key){
        socket.emit("overlay:join", { room, key, overlay: OVERLAY_NAME });
        console.log("‚û°Ô∏è overlay:join", { room, key: "***", overlay: OVERLAY_NAME });

        setDbg([
          "<b>Overlay:</b> commentaires",
          `<b>room:</b> ${room}`,
          `<b>key:</b> ‚úÖ (pr√©sent)`,
          `<b>socket:</b> ‚úÖ connected`,
          `<b>join:</b> ‚úÖ envoy√© (avec key)`,
          "<b>last raw_vote:</b> ‚Äî",
        ]);
      }else{
        setDbg([
          "<b>Overlay:</b> commentaires",
          `<b>room:</b> ${room || "‚ùå (manquant)"}`,
          `<b>key:</b> ${key ? "‚úÖ" : "‚ùå (manquant)"}`,
          "<b>socket:</b> ‚úÖ connected",
          "<b>join:</b> ‚õî non envoy√© (room/key manquants)",
          "<b>last raw_vote:</b> ‚Äî",
        ]);
      }

      // anti-flicker: on affiche seulement apr√®s connect
      document.body.classList.remove("is-loading");
    });

    socket.on("overlay:forbidden", () => {
      setDot(false);
      setDbg([
        "<b>Overlay:</b> commentaires",
        `<b>room:</b> ${room || "?"}`,
        `<b>key:</b> ${key ? "‚úÖ" : "‚ùå"}`,
        "<b>socket:</b> ‚úÖ connected",
        "<b>join:</b> ‚õî FORBIDDEN",
        "<b>last raw_vote:</b> ‚Äî",
      ]);
      hide();
    });

    socket.on("disconnect", () => {
      setDot(false);
      setDbg([
        "<b>Overlay:</b> commentaires",
        `<b>room:</b> ${room || "?"}`,
        `<b>key:</b> ${key ? "‚úÖ" : "‚ùå"}`,
        "<b>socket:</b> ‚ùå disconnected",
        "<b>join:</b> ‚Äî",
        "<b>last raw_vote:</b> ‚Äî",
      ]);
      hide();
    });

    // ‚úÖ Collecte brute: raw_vote => affiche direct (mode test collecte)
    socket.on("raw_vote", (data) => {
      const txt = clean(data?.vote);
      const usr = clean(data?.user);

      if(!txt) return;

      // anti-doublons
      const now = Date.now();
      pruneSeen(now);
      const sig = (usr + "|" + txt).toLowerCase();
      const last = seen.get(sig);
      if(last && (now - last) < DEDUPE_WINDOW_MS) return;
      seen.set(sig, now);

      // debug
      setDbg([
        "<b>Overlay:</b> commentaires",
        `<b>room:</b> ${room || "?"}`,
        `<b>key:</b> ${key ? "‚úÖ (pr√©sent)" : "‚ùå"}`,
        `<b>socket:</b> ‚úÖ connected`,
        `<b>join:</b> ${room && key ? "‚úÖ envoy√© (avec key)" : "‚õî non envoy√©"}`,
        `<b>last raw_vote:</b> ${txt}`,
      ]);

      show(txt, usr);
    });

    // Pilotage optionnel si tu r√©actives une t√©l√©commande plus tard
    socket.on("control:set_state", (payload) => {
      if(payload?.overlay && clean(payload.overlay) !== OVERLAY_NAME) return;

      const state = clean(payload?.state);
      if(state === "show"){
        const txt = clean(payload?.data?.text ?? payload?.text);
        const usr = clean(payload?.data?.user ?? payload?.user);
        show(txt, usr);
      }
      if(state === "hide"){
        hide();
      }
    });
  }

  connect();
</script>
</body>
</html>
