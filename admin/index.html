<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>MDI ‚Ä¢ Admin Cockpit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #0f172a; --panel: #1e293b; --text: #f1f5f9; --accent: #3b82f6; --danger: #ef4444; --success: #22c55e; }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { display: flex; align-items: center; justify-content: space-between; }
    
    /* Tabs */
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { background: var(--panel); padding: 10px 20px; border-radius: 8px; cursor: pointer; opacity: 0.6; font-weight: 600; }
    .tab.active { opacity: 1; background: var(--accent); }
    
    /* Panels */
    .view { display: none; }
    .view.active { display: block; }
    
    /* Cards */
    .card { background: var(--panel); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    
    label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 4px; }
    input, select, textarea { width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 6px; box-sizing: border-box; }
    
    button { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    button:hover { opacity: 0.9; }
    button.danger { background: var(--danger); }
    button.secondary { background: #334155; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid #334155; }
    th { color: #94a3b8; }
    .tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; text-transform: uppercase; font-weight: bold; }
    .tag.quiz { background: #8b5cf6; color: white; }
    .tag.poll { background: #06b6d4; color: white; }
    
    .loading { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>

<div class="container">
  <h1>
    <span>üöÄ MDI Admin</span>
    <button onclick="refreshData()" class="secondary">üîÑ Refresh</button>
  </h1>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('clients')">üë• Clients (Rooms)</div>
    <div class="tab" onclick="switchTab('questions')">‚ùì Questions</div>
  </div>

  <div id="view-clients" class="view active">
    <div class="card">
      <h3>Ajouter / Modifier un Client</h3>
      <form id="formClient">
        <div class="row">
          <div><label>ID Client (Room ID)</label><input id="c_id" placeholder="Ex: CLIENT_BMW" required></div>
          <div><label>Cl√© Secr√®te (Room Key)</label><input id="c_key" placeholder="Ex: secret_123" required></div>
        </div>
        <div class="row">
          <div><label>Actif ?</label><select id="c_active"><option value="true">OUI</option><option value="false">NON</option></select></div>
        </div>
        <div style="margin-bottom:10px">
          <label>Droits (Entitlements)</label>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <label><input type="checkbox" class="ent" value="quiz_ou_sondage" checked> Quiz/Sondage</label>
            <label><input type="checkbox" class="ent" value="confetti" checked> Confettis</label>
            <label><input type="checkbox" class="ent" value="tug_of_war" checked> Tug of War</label>
          </div>
        </div>
        <button type="submit">üíæ Sauvegarder Client</button>
      </form>
    </div>

    <div class="card">
      <h3>Liste des Clients</h3>
      <table id="tableClients">
        <thead><tr><th>Room ID</th><th>Key</th><th>Active</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="view-questions" class="view">
    <div class="card">
      <h3>√âditer une Question</h3>
      <form id="formQuestion">
        <div class="row">
          <div><label>Client (Room ID)</label><input id="q_room" placeholder="Ex: DEMO_CLIENT" required></div>
          <div><label>Code Question (ex: Q001)</label><input id="q_key" placeholder="Q001" required></div>
        </div>
        <div class="row">
          <div><label>Type</label><select id="q_type"><option value="quiz">Quiz (Bonne r√©ponse)</option><option value="poll">Sondage (Avis)</option></select></div>
          <div><label>Ordre</label><input type="number" id="q_order" value="1"></div>
        </div>
        <div style="margin-bottom:10px"><label>Intitul√© (Prompt)</label><textarea id="q_prompt" rows="2" required></textarea></div>
        
        <div class="row">
          <div><label>Option A</label><input id="q_a" required></div>
          <div><label>Option B</label><input id="q_b" required></div>
        </div>
        <div class="row">
          <div><label>Option C</label><input id="q_c"></div>
          <div><label>Option D</label><input id="q_d"></div>
        </div>
        
        <div class="row" id="rowCorrect">
          <div><label>Bonne R√©ponse (Quiz)</label><select id="q_correct"><option value="A">Option A</option><option value="B">Option B</option><option value="C">Option C</option><option value="D">Option D</option></select></div>
        </div>

        <button type="submit">üíæ Sauvegarder Question</button>
      </form>
    </div>

    <div class="card">
      <h3>Catalogue Questions</h3>
      <table id="tableQuestions">
        <thead><tr><th>Room</th><th>Key</th><th>Type</th><th>Prompt</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script>
const API_URL = "https://magic-digital-impact-live.onrender.com/api/admin";
const SECRET = "MDI_SUPER_ADMIN_2026"; // Doit matcher server.js

// --- NAVIGATION ---
function switchTab(tab) {
  document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
  document.getElementById('view-'+tab).classList.add('active');
  document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
}

// --- DATA FETCH ---
async function apiCall(endpoint, method="GET", body=null) {
  const opts = {
    method,
    headers: { "Content-Type": "application/json", "x-admin-secret": SECRET }
  };
  if(body) opts.body = JSON.stringify(body);
  try {
    const res = await fetch(API_URL + endpoint, opts);
    return await res.json();
  } catch(e) { alert("Erreur API: " + e); return {ok:false}; }
}

async function refreshData() {
  document.body.classList.add("loading");
  const res = await apiCall("/data");
  document.body.classList.remove("loading");
  
  if(!res.ok) return alert("Erreur chargement (Check server logs)");
  
  // Render Clients
  const tbodyC = document.querySelector("#tableClients tbody");
  tbodyC.innerHTML = res.clients.map(c => `
    <tr>
      <td><b>${c.room_id}</b></td>
      <td>${c.room_key}</td>
      <td>${c.active ? '‚úÖ' : '‚ùå'}</td>
      <td><button class="secondary" onclick="editClient('${c.room_id}')">Edit</button></td>
    </tr>
  `).join('');
  
  // Render Questions
  const tbodyQ = document.querySelector("#tableQuestions tbody");
  tbodyQ.innerHTML = res.questions.map(q => `
    <tr>
      <td>${q.room_id}</td>
      <td><b>${q.question_key}</b></td>
      <td><span class="tag ${q.type}">${q.type}</span></td>
      <td>${q.prompt}</td>
      <td>
        <button class="secondary" onclick="editQuestion('${q.room_id}', '${q.question_key}')">‚úèÔ∏è</button>
        <button class="danger" onclick="deleteQuestion('${q.room_id}', '${q.question_key}')">üóëÔ∏è</button>
      </td>
    </tr>
  `).join('');
  
  window.rawData = res; // Stocker pour edit
}

// --- FORMS ---
document.getElementById("formClient").onsubmit = async (e) => {
  e.preventDefault();
  const ents = {};
  document.querySelectorAll(".ent:checked").forEach(el => ents[el.value] = true);
  
  const body = {
    room_id: document.getElementById("c_id").value,
    room_key: document.getElementById("c_key").value,
    active: document.getElementById("c_active").value === "true",
    entitlements: ents
  };
  
  await apiCall("/client", "POST", body);
  refreshData();
  alert("Client sauvegard√© !");
};

document.getElementById("formQuestion").onsubmit = async (e) => {
  e.preventDefault();
  const body = {
    room_id: document.getElementById("q_room").value,
    question_key: document.getElementById("q_key").value,
    type: document.getElementById("q_type").value,
    order_index: document.getElementById("q_order").value,
    prompt: document.getElementById("q_prompt").value,
    option_a: document.getElementById("q_a").value,
    option_b: document.getElementById("q_b").value,
    option_c: document.getElementById("q_c").value,
    option_d: document.getElementById("q_d").value,
    correct_option: document.getElementById("q_correct").value,
    enabled: true
  };
  
  await apiCall("/question", "POST", body);
  refreshData();
  alert("Question sauvegard√©e !");
};

// --- ACTIONS ---
window.editClient = (id) => {
  const c = window.rawData.clients.find(x => x.room_id === id);
  if(!c) return;
  document.getElementById("c_id").value = c.room_id;
  document.getElementById("c_key").value = c.room_key;
  document.getElementById("c_active").value = c.active.toString();
};

window.editQuestion = (rid, qid) => {
  const q = window.rawData.questions.find(x => x.room_id === rid && x.question_key === qid);
  if(!q) return;
  document.getElementById("q_room").value = q.room_id;
  document.getElementById("q_key").value = q.question_key;
  document.getElementById("q_type").value = q.type;
  document.getElementById("q_prompt").value = q.prompt;
  document.getElementById("q_a").value = q.option_a;
  document.getElementById("q_b").value = q.option_b;
  document.getElementById("q_c").value = q.option_c;
  document.getElementById("q_d").value = q.option_d;
  switchTab('questions');
};

window.deleteQuestion = async (rid, qid) => {
  if(!confirm("Supprimer " + qid + " ?")) return;
  await apiCall("/delete-question", "POST", { room_id: rid, question_key: qid });
  refreshData();
};

// Init
refreshData();
</script>

</body>
</html>