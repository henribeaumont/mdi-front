<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDI - Gestionnaire Commentaires</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --border: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    /* Header */
    .header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      align-items: center;
    }

    .header-title {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .auth-inputs {
      display: flex;
      gap: 8px;
    }

    .auth-inputs input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-dark);
      color: var(--text);
      font-size: 12px;
      width: 140px;
    }

    .btn-connect {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: var(--accent);
      color: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-connect:hover {
      background: #2563eb;
    }

    /* Layout 2 colonnes */
    .columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--border);
      border-top: 1px solid var(--border);
    }

    .column {
      background: var(--bg-card);
      padding: 16px;
      min-height: 600px;
      max-height: 600px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .column-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .column-actions {
      display: flex;
      gap: 6px;
    }

    /* Messages */
    .messages-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message-item {
      background: var(--bg-dark);
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .message-item:hover {
      border-color: var(--border);
    }

    .message-item.selected {
      border-color: var(--success);
      box-shadow: 0 0 0 1px var(--success);
    }

    .message-item.sent {
      opacity: 0.6;
    }

    .message-item.displayed {
      opacity: 0.5;
      background: #1a1a2a;
    }

    .message-author {
      font-size: 12px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .message-text {
      font-size: 13px;
      color: var(--text);
      line-height: 1.4;
      margin-bottom: 8px;
    }

    .message-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }

    .message-check {
      position: absolute;
      top: 8px;
      right: 8px;
      color: var(--success);
      font-size: 16px;
      display: none;
    }

    .message-item.sent .message-check {
      display: block;
    }

    /* Boutons */
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:active {
      transform: scale(0.98);
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 10px;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #16a34a;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: #475569;
    }

    /* Message vide */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* Scrollbar */
    .column::-webkit-scrollbar {
      width: 8px;
    }

    .column::-webkit-scrollbar-track {
      background: var(--bg-dark);
    }

    .column::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .column::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-title">
        üí¨ Gestionnaire de Commentaires
      </div>
      <div class="status-indicator">
        <div class="status-dot"></div>
        <span>Overlay Actif</span>
      </div>
      <div class="auth-inputs">
        <input type="text" id="roomId" placeholder="Room ID">
        <input type="password" id="roomKey" placeholder="Room Key">
        <button id="btnConnect" class="btn-connect">Connecter</button>
      </div>
    </div>

    <!-- 2 Colonnes -->
    <div class="columns">
      <!-- Colonne FLUX -->
      <div class="column">
        <div class="column-header">
          <div class="column-title">üì• FLUX</div>
          <div class="column-actions">
            <button class="btn-danger btn-small" onclick="resetFlux()">üßπ Nettoyer</button>
          </div>
        </div>
        <div id="fluxList" class="messages-list">
          <div class="empty-state">Aucun message pour le moment</div>
        </div>
      </div>

      <!-- Colonne EN ATTENTE -->
      <div class="column">
        <div class="column-header">
          <div class="column-title">üì∫ EN ATTENTE</div>
          <div class="column-actions">
            <button class="btn-success btn-small" onclick="showComment()">üëÅÔ∏è Afficher</button>
            <button class="btn-secondary btn-small" onclick="hideComment()">üôà Masquer</button>
            <button class="btn-danger btn-small" onclick="resetQueue()">üßπ Vider</button>
          </div>
        </div>
        <div id="queueList" class="messages-list">
          <div class="empty-state">Aucun commentaire en attente</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SERVER_URL = "https://magic-digital-impact-live.onrender.com";
    
    let socket = null;
    let connected = false;
    let currentRoom = "";
    
    let fluxMessages = [];
    let queueMessages = [];
    let selectedQueueId = null;

    const $ = (id) => document.getElementById(id);

    // --- CONNEXION ---
    function connect() {
      const room = $("roomId").value.trim();
      const key = $("roomKey").value.trim();

      if (!room || !key) {
        alert("‚ö†Ô∏è Room ID et Key requis");
        return;
      }

      currentRoom = room;

      if (socket) socket.disconnect();

      socket = io(SERVER_URL, {
        transports: ["websocket", "polling"],
        reconnection: true
      });

      socket.on("connect", () => {
        console.log("‚úÖ Connect√©");
        connected = true;
        socket.emit("rejoindre_salle", currentRoom);
        
        // Activer automatiquement l'overlay commentaires
        setTimeout(() => {
          socket.emit("control:activate_overlay", {
            room: currentRoom,
            overlay: "commentaires"
          });
          console.log("‚úÖ Overlay commentaires activ√©");
        }, 500);
      });

      socket.on("connect_error", (err) => {
        console.error("‚ùå Erreur:", err);
        connected = false;
      });

      socket.on("disconnect", () => {
        console.warn("‚ö†Ô∏è D√©connect√©");
        connected = false;
      });

      socket.on("overlay:state", (payload) => {
        console.log("üì° √âtat:", payload);
        if (payload.overlay === "commentaires" && payload.data) {
          if (payload.data.flux) fluxMessages = payload.data.flux;
          if (payload.data.queue) queueMessages = payload.data.queue;
          renderFlux();
          renderQueue();
        }
      });
    }

    // --- RENDER ---
    function renderFlux() {
      const list = $("fluxList");
      
      if (fluxMessages.length === 0) {
        list.innerHTML = '<div class="empty-state">Aucun message pour le moment</div>';
        return;
      }

      list.innerHTML = fluxMessages.map(msg => `
        <div class="message-item ${msg.sent ? 'sent' : ''}" data-id="${msg.id}">
          <div class="message-check">‚úì</div>
          <div class="message-author">${msg.author}</div>
          <div class="message-text">${msg.text}</div>
          <div class="message-actions">
            <button class="btn-danger btn-small" onclick="deleteFluxMessage('${msg.id}')">‚ùå</button>
            <button class="btn-primary btn-small" onclick="sendToQueue('${msg.id}')" ${msg.sent ? 'disabled' : ''}>‚Üí</button>
          </div>
        </div>
      `).join('');
    }

    function renderQueue() {
      const list = $("queueList");
      
      if (queueMessages.length === 0) {
        list.innerHTML = '<div class="empty-state">Aucun commentaire en attente</div>';
        return;
      }

      list.innerHTML = queueMessages.map(msg => `
        <div class="message-item ${msg.displayed ? 'displayed' : ''} ${selectedQueueId === msg.id ? 'selected' : ''}" 
             data-id="${msg.id}" 
             onclick="selectQueueMessage('${msg.id}')">
          <div class="message-author">${msg.author}</div>
          <div class="message-text">${msg.text}</div>
          <div class="message-actions">
            <button class="btn-danger btn-small" onclick="event.stopPropagation(); deleteQueueMessage('${msg.id}')">‚ùå</button>
          </div>
        </div>
      `).join('');
    }

    // --- ACTIONS FLUX ---
    function sendToQueue(msgId) {
      if (!connected) return;
      
      socket.emit("control:comment_to_queue", {
        room: currentRoom,
        messageId: msgId
      });
      
      console.log(`‚Üí [FLUX] Message ${msgId} envoy√© vers queue`);
    }

    function deleteFluxMessage(msgId) {
      if (!connected) return;
      
      socket.emit("control:comment_delete", {
        room: currentRoom,
        column: "flux",
        messageId: msgId
      });
      
      console.log(`‚ùå [FLUX] Message ${msgId} supprim√©`);
    }

    function resetFlux() {
      if (!connected) return;
      if (!confirm("Vider toute la colonne FLUX ?")) return;
      
      socket.emit("control:comment_reset_flux", {
        room: currentRoom
      });
      
      console.log("üßπ [FLUX] Colonne nettoy√©e");
    }

    // --- ACTIONS QUEUE ---
    function selectQueueMessage(msgId) {
      selectedQueueId = msgId;
      renderQueue();
      console.log(`‚úì [QUEUE] Message ${msgId} s√©lectionn√©`);
    }

    function showComment() {
      if (!connected || !selectedQueueId) return;
      
      socket.emit("control:comment_show", {
        room: currentRoom,
        messageId: selectedQueueId
      });
      
      console.log(`üëÅÔ∏è [QUEUE] Affichage message ${selectedQueueId}`);
    }

    function hideComment() {
      if (!connected) return;
      
      socket.emit("control:comment_hide", {
        room: currentRoom
      });
      
      console.log("üôà [QUEUE] Commentaire masqu√©");
    }

    function deleteQueueMessage(msgId) {
      if (!connected) return;
      
      socket.emit("control:comment_delete", {
        room: currentRoom,
        column: "queue",
        messageId: msgId
      });
      
      console.log(`‚ùå [QUEUE] Message ${msgId} supprim√©`);
      
      if (selectedQueueId === msgId) {
        selectedQueueId = null;
      }
    }

    function resetQueue() {
      if (!connected) return;
      if (!confirm("Vider toute la colonne EN ATTENTE ?")) return;
      
      socket.emit("control:comment_reset_queue", {
        room: currentRoom
      });
      
      selectedQueueId = null;
      
      console.log("üßπ [QUEUE] Colonne vid√©e");
    }

    // --- INIT ---
    $("btnConnect").onclick = connect;

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("room")) $("roomId").value = urlParams.get("room");
    if (urlParams.get("key")) $("roomKey").value = urlParams.get("key");
  </script>
</body>
</html>
