<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MDI ‚Ä¢ T√©l√©commande Commentaires</title>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    :root{
      --bg:#0A0F1E;
      --panel:rgba(255,255,255,0.06);
      --text:rgba(255,255,255,0.92);
      --accent:#2ecc71;
      --danger:#ff3b30;
      --warn:#F9AD48;
      --font:ui-sans-serif,system-ui,sans-serif;
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--font);
      padding:16px;
    }
    .wrap{ max-width:720px; margin:auto; display:grid; gap:14px; }
    .card{
      background:var(--panel);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:16px;
      padding:14px;
    }
    .title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:800;
    }
    .dot{
      width:12px;height:12px;border-radius:50%;
      background:#555;
    }
    .dot.ok{ background:var(--accent); box-shadow:0 0 0 4px rgba(46,204,113,.25); }
    .dot.bad{ background:var(--danger); }

    input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid #444;
      background:#111;
      color:#fff;
      margin-bottom:8px;
    }
    label{ font-size:12px; color:#aaa; display:block; margin-bottom:4px; }

    .chat{
      max-height:360px;
      overflow:auto;
      display:grid;
      gap:6px;
    }
    .msg{
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.08);
      cursor:pointer;
      transition:background .15s,border .15s, transform .05s;
      user-select:none;
      line-height:1.25;
      word-break:break-word;
    }
    .msg:active{ transform:scale(0.99); }
    .msg:hover{ background:rgba(255,255,255,0.06); }

    /* s√©lection simple (pas encore "affich√©") */
    .msg.selected{
      background:rgba(249,173,72,0.14);
      border-color:rgba(249,173,72,0.45);
    }

    /* celui qui est r√©ellement affich√© sur l'overlay */
    .msg.displayed{
      background:rgba(46,204,113,0.22);
      border-color:rgba(46,204,113,0.70);
      box-shadow:0 0 0 4px rgba(46,204,113,0.10) inset;
    }

    .btn{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:none;
      font-weight:800;
      cursor:pointer;
      background:rgba(255,255,255,0.1);
      color:#fff;
      margin-top:8px;
    }
    .btn.show{
      background:rgba(46,204,113,0.25);
      color:#7CFFB2;
    }
    .btn.hide{
      background:rgba(255,59,48,0.25);
      color:#ff9b94;
    }
    .btn:disabled{ opacity:.4; cursor:not-allowed; }

    .hint{
      margin-top:8px;
      font-size:12px;
      color:rgba(255,255,255,0.55);
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="card title">
    <span>MDI ‚Ä¢ T√©l√©commande Commentaires</span>
    <span id="dot" class="dot"></span>
  </div>

  <div class="card">
    <label>ID_SALLE</label>
    <input id="room" placeholder="ID_SALLE" autocomplete="off" />
    <label>ROOM_KEY</label>
    <input id="key" placeholder="ROOM_KEY" autocomplete="off" />
    <button id="connect" class="btn">Connexion</button>
    <div class="hint">Clique un message pour le s√©lectionner. Le message affich√© √† l‚Äô√©cran passe en vert. Le bouton ‚ÄúMasquer‚Äù devient rouge.</div>
  </div>

  <div class="card">
    <div id="chat" class="chat"></div>
    <button id="toggle" class="btn show" disabled>Afficher le commentaire</button>
  </div>

</div>

<script>
/**
 * üîß SWITCH COMPATIBILIT√â
 * - Si ton overlay r√©agit √† control:set_state : laisse "set_state"
 * - Si ton overlay ne r√©agit pas : mets "commentaires"
 */
const CONTROL_MODE = "set_state"; // "set_state" | "commentaires"

const SERVER_URL = "https://magic-digital-impact-live.onrender.com";
const OVERLAY = "commentaires";

let socket = null;

// message s√©lectionn√© (cliqu√©), et message affich√© (r√©ellement envoy√© en show)
let selectedText = null;
let displayedText = null;

// anti-doublons pour raw_vote (√©vite 50 copies dans la t√©l√©commande)
const seen = new Map(); // hash -> lastSeenTs
const DEDUPE_WINDOW_MS = 2500;

const $ = id => document.getElementById(id);
const dot = $("dot");
const chat = $("chat");
const btn = $("toggle");

function setStatus(ok){
  dot.className = "dot " + (ok ? "ok" : "bad");
}

function cleanText(t){
  return String(t ?? "")
    .replace(/\u00A0/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function hashText(t){
  let s = cleanText(t).toLowerCase();
  let h = 0;
  for(let i=0;i<s.length;i++){
    h = ((h << 5) - h) + s.charCodeAt(i);
    h |= 0;
  }
  return String(h);
}

function pruneSeen(now){
  for(const [k, ts] of seen.entries()){
    if(now - ts > DEDUPE_WINDOW_MS) seen.delete(k);
  }
}

function setButtonMode(){
  const isDisplayed = !!displayedText;

  if(!selectedText){
    btn.disabled = true;
    btn.textContent = "Afficher le commentaire";
    btn.className = "btn show";
    return;
  }

  btn.disabled = false;

  if(isDisplayed){
    btn.textContent = "Masquer le commentaire";
    btn.className = "btn hide";
  }else{
    btn.textContent = "Afficher le commentaire";
    btn.className = "btn show";
  }
}

function markSelectionAndDisplay(){
  chat.querySelectorAll(".msg").forEach(m => {
    m.classList.remove("selected");
    m.classList.remove("displayed");
    if(m.dataset.text === selectedText) m.classList.add("selected");
    if(displayedText && m.dataset.text === displayedText) m.classList.add("displayed");
  });
}

/* ‚úÖ √âmission SHOW/HIDE : 2 modes possibles selon ton serveur/overlay */
function emitShow(text){
  if(!socket || !socket.connected) return;
  const room = $("room").value.trim();
  const key  = $("key").value.trim();

  if(CONTROL_MODE === "set_state"){
    socket.emit("control:set_state", {
      room, key, overlay: OVERLAY,
      state: "show",
      data: { text }
    });
  } else {
    socket.emit("control:commentaires", {
      room,
      action: "show",
      text,
      user: ""
    });
  }
}

function emitHide(){
  if(!socket || !socket.connected) return;
  const room = $("room").value.trim();
  const key  = $("key").value.trim();

  if(CONTROL_MODE === "set_state"){
    socket.emit("control:set_state", {
      room, key, overlay: OVERLAY,
      state: "hide"
    });
  } else {
    socket.emit("control:commentaires", {
      room,
      action: "hide"
    });
  }
}

$("connect").onclick = () => {
  const room = $("room").value.trim();
  const key  = $("key").value.trim();
  if(!room || !key) return;

  if(socket) socket.disconnect();
  socket = io(SERVER_URL, { transports: ["websocket", "polling"] });

  socket.on("connect", () => {
    setStatus(true);
    socket.emit("overlay:join", { room, key, overlay: OVERLAY });
  });

  socket.on("overlay:forbidden", () => {
    setStatus(false);
    alert("Acc√®s refus√©");
  });

  socket.on("disconnect", () => setStatus(false));

  socket.on("raw_vote", data => {
    const txt = cleanText(data?.vote);
    if(!txt) return;

    const now = Date.now();
    pruneSeen(now);

    const h = hashText(txt);
    const last = seen.get(h);
    if(last && (now - last) < DEDUPE_WINDOW_MS){
      return; // ignore doublon UI
    }
    seen.set(h, now);

    addMessage(txt);
  });
};

function addMessage(text){
  const div = document.createElement("div");
  div.className = "msg";
  div.textContent = text;
  div.dataset.text = text;

  div.onclick = () => {
    selectedText = text;

    // Si un commentaire est d√©j√† affich√©, cliquer un autre message => switch direct
    if(displayedText){
      displayedText = text;
      emitShow(displayedText);
    }

    markSelectionAndDisplay();
    setButtonMode();
  };

  chat.prepend(div);
  markSelectionAndDisplay();
}

btn.onclick = () => {
  if(!selectedText || !socket || !socket.connected) return;

  if(!displayedText){
    displayedText = selectedText;
    emitShow(displayedText);
  } else {
    emitHide();
    displayedText = null;
  }

  markSelectionAndDisplay();
  setButtonMode();
};

// init bouton
setButtonMode();

// Pr√©remplissage URL optionnel (?room=...&key=...)
const u = new URL(location.href);
if(u.searchParams.get("room")) $("room").value = u.searchParams.get("room");
if(u.searchParams.get("key")) $("key").value = u.searchParams.get("key");
</script>
</body>
</html>
