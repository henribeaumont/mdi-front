<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MDI ‚Ä¢ T√©l√©commande Quiz</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root{
      --bg:#0A0F1E; --panel:rgba(255,255,255,0.06); --text:rgba(255,255,255,0.92);
      --accent:#F9AD48; --danger:#ff3b30; --ok:#2ecc71;
      --font:ui-sans-serif,system-ui,sans-serif;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--font); padding:18px; }
    .wrap{ max-width:600px; margin:0 auto; display:grid; gap:14px; }
    .card{ background:var(--panel); border:1px solid rgba(255,255,255,0.12); border-radius:18px; padding:14px; }
    .title{ font-weight:800; display:flex; justify-content:space-between; align-items:center; }
    .dot{ width:12px; height:12px; border-radius:99px; background:#555; display:inline-block; }
    .dot.ok{ background:var(--ok); box-shadow:0 0 0 4px rgba(46,204,113,0.16); }
    .dot.bad{ background:var(--danger); }
    input, select{ width:100%; padding:12px; border-radius:12px; border:1px solid #444; background:#222; color:#fff; margin-bottom:8px; }
    label{ font-size:12px; color:#aaa; display:block; margin-bottom:4px; }
    .btn{ width:100%; padding:14px; border-radius:14px; border:none; background:rgba(255,255,255,0.1); color:#fff; font-weight:bold; cursor:pointer; margin-bottom:8px; }
    .btn:active{ transform:scale(0.98); }
    .btn.primary{ background:rgba(249,173,72,0.2); color:var(--accent); border:1px solid rgba(249,173,72,0.3); }
    .btn.danger{ background:rgba(255,59,48,0.2); color:#ff6b6b; }
    .btn:disabled{ opacity:0.4; cursor:not-allowed; }
    .tv{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .full{ grid-column: 1 / -1; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card title">
      <span>MDI ‚Ä¢ Quiz Remote</span>
      <span id="dot" class="dot"></span>
    </div>

    <div class="card">
      <label>ID_SALLE</label>
      <input id="roomId" placeholder="ID_SALLE" autocomplete="off" />
      <label>ROOM_KEY</label>
      <input id="roomKey" placeholder="ROOM_KEY" autocomplete="off" />
      <button id="btnConnect" class="btn primary">1. Connecter + Charger Catalogue</button>
    </div>

    <div class="card">
      <label>Choisir une question</label>
      <select id="questionSelect"><option value="">(Connectez-vous d'abord)</option></select>

      <div class="tv">
        <button id="btnLoad" class="btn primary full">2. Afficher la question ‚ùì (DB)</button>

        <button id="btnOpen" class="btn">Afficher options üó≥Ô∏è</button>
        <button id="btnResults" class="btn">R√©sultats %</button>
        <button id="btnReveal" class="btn">R√©ponse ‚úÖ</button>
        <button id="btnWinner" class="btn">Gagnant ü•á</button>
      </div>

      <button id="btnReset" class="btn danger" style="margin-top:12px">Reset (Effacer)</button>
    </div>
  </div>

<script>
const SERVER_URL = "https://magic-digital-impact-live.onrender.com";
const OVERLAY_NAME = "quiz_ou_sondage";

const $ = (id) => document.getElementById(id);
let socket = null;
let questions = [];

function setStatus(ok) {
  $("dot").className = ok ? "dot ok" : "dot bad";
}

$("btnConnect").onclick = async () => {
  const room = $("roomId").value.trim();
  const key = $("roomKey").value.trim();
  if(!room || !key) return alert("Il manque ID_SALLE ou ROOM_KEY.");

  if(socket) socket.disconnect();
  socket = io(SERVER_URL, { transports: ["websocket", "polling"] });

  socket.on("connect", () => {
    setStatus(true);
    socket.emit("overlay:join", { room, key, overlay: OVERLAY_NAME });
  });

  socket.on("overlay:forbidden", () => { setStatus(false); alert("Acc√®s refus√© : ROOM_KEY invalide."); });
  socket.on("disconnect", () => setStatus(false));

  try {
    const res = await fetch(`${SERVER_URL}/debug/questions?room=${encodeURIComponent(room)}`);
    const json = await res.json();
    questions = json.data || [];

    const sel = $("questionSelect");
    sel.innerHTML = '<option value="">-- Choisir --</option>';
    questions.forEach(q => {
      const opt = document.createElement("option");
      opt.value = q.question_key;
      opt.textContent = `${q.question_key} - ${q.prompt}`;
      sel.appendChild(opt);
    });
  } catch(e) {
    alert("Erreur catalogue: " + e.message);
  }
};

function send(action, payload={}) {
  if(!socket || !socket.connected) return alert("Pas connect√©.");
  const room = $("roomId").value.trim();
  const key = $("roomKey").value.trim();
  socket.emit(action, { room, key, overlay: OVERLAY_NAME, ...payload });
}

$("btnLoad").onclick = () => {
  const qKey = $("questionSelect").value;
  if(!qKey) return alert("Choisis une question.");
  send("control:load_question", { question_key: qKey });
};

$("btnOpen").onclick = () => send("control:show_options");
$("btnResults").onclick = () => send("control:set_state", { state: "results" });
$("btnReveal").onclick = () => send("control:set_state", { state: "reveal" });
$("btnWinner").onclick = () => send("control:set_state", { state: "winner" });
$("btnReset").onclick = () => send("control:idle");

// Pr√©remplissage URL (si tu utilises ?room=...&key=...)
const u = new URL(location.href);
if(u.searchParams.get("room")) $("roomId").value = u.searchParams.get("room");
if(u.searchParams.get("key")) $("roomKey").value = u.searchParams.get("key");
</script>
</body>
</html>
