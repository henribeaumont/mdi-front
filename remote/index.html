<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDI Live - T√©l√©commande V3.5</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --border: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px;
    }

    /* ===================== LAYOUT ===================== */
    .container {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    /* T√©l√©commande standard : max 420px */
    .container.narrow { max-width: 420px; }
    /* Onglet commentaires : max 1200px */
    .container.wide { max-width: 1200px; }

    /* ===================== HEADER ===================== */
    .header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: end;
    }

    .auth-inputs { display: flex; flex-direction: column; gap: 6px; }
    .auth-inputs input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-dark);
      color: var(--text);
      font-size: 12px;
    }
    .auth-inputs input:focus { outline: none; border-color: var(--accent); }

    .header-connect { display: flex; flex-direction: column; gap: 4px; align-items: center; }

    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--danger);
      transition: all 0.3s;
    }
    .status-dot.connected {
      background: var(--success);
      box-shadow: 0 0 0 3px rgba(34,197,94,0.2);
    }

    .btn-connect {
      padding: 10px 16px;
      border: none; border-radius: 6px;
      background: var(--accent); color: white;
      font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-connect:hover { background: #2563eb; }
    .btn-connect:active { transform: scale(0.98); }

    /* ===================== ONGLETS ===================== */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--bg-dark);
      overflow-x: auto;
    }

    .tab {
      flex: 1;
      padding: 12px 8px;
      border: none; background: transparent;
      color: var(--text-muted);
      font-size: 22px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
    }
    .tab:hover { color: var(--text); background: rgba(255,255,255,0.05); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); background: var(--bg-card); }

    /* ===================== CONTENU ONGLETS ===================== */
    .tab-content { display: none; padding: 16px; }
    .tab-content.active { display: block; }

    /* L'onglet commentaires a son propre layout */
    .tab-content.comments-tab { padding: 0; }
    .tab-content.comments-tab.active { display: flex; flex-direction: column; }

    /* ===================== TOGGLES ===================== */
    .toggle-container {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px;
      background: var(--bg-dark);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .toggle-label { display: flex; align-items: center; gap: 10px; font-size: 15px; font-weight: 600; }
    .toggle-label .icon { font-size: 24px; }

    .toggle-switch {
      position: relative; width: 48px; height: 26px;
      background: var(--danger);
      border-radius: 13px; cursor: pointer; transition: background 0.3s;
      flex-shrink: 0;
    }
    .toggle-switch.active { background: var(--success); }
    .toggle-switch::after {
      content: ''; position: absolute;
      width: 20px; height: 20px;
      background: white; border-radius: 50%;
      top: 3px; left: 3px; transition: left 0.3s;
    }
    .toggle-switch.active::after { left: 25px; }

    /* ===================== BOUTONS G√âN√âRAUX ===================== */
    button {
      width: 100%; padding: 11px;
      border: none; border-radius: 6px;
      font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    button:active { transform: scale(0.98); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover:not(:disabled) { background: #2563eb; }

    .btn-success { background: var(--success); color: white; }
    .btn-success:hover:not(:disabled) { background: #16a34a; }

    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-secondary:hover:not(:disabled) { background: #475569; }

    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover:not(:disabled) { background: #dc2626; }

    .btn-warning { background: var(--warning); color: white; }
    .btn-warning:hover:not(:disabled) { background: #d97706; }

    .btn-small {
      width: auto; padding: 4px 8px;
      font-size: 11px; font-weight: 600;
      border-radius: 4px; cursor: pointer;
      border: none; transition: all 0.15s;
      display: inline-flex; align-items: center; gap: 4px;
    }
    .btn-small:active { transform: scale(0.95); }

    /* ===================== S√âPARATEUR ===================== */
    .separator { height: 1px; background: var(--border); margin: 12px 0; }

    /* ===================== STATUS INDICATOR ===================== */
    /* ===================== VOYANTS OVERLAY (2 par overlay) ===================== */
    .overlay-status {
      display: flex; align-items: center; justify-content: center;
      gap: 20px; margin-bottom: 12px;
    }
    .overlay-voyant {
      display: flex; align-items: center; gap: 6px;
    }
    .overlay-status-dot {
      width: 10px; height: 10px;
      border-radius: 50%; background: var(--danger);
      transition: all 0.3s; flex-shrink: 0;
    }
    .overlay-status-dot.on {
      background: var(--success);
      box-shadow: 0 0 0 3px rgba(34,197,94,0.2);
    }
    .overlay-status-label { font-size: 11px; color: var(--text-muted); }

    /* ===================== MESSAGE FLASH ===================== */
    .flash-msg {
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 12px;
      display: none;
    }
    .flash-msg.show { display: block; }
    .flash-msg.success { background: rgba(34,197,94,0.1); color: var(--success); border: 1px solid var(--success); }
    .flash-msg.error { background: rgba(239,68,68,0.1); color: var(--danger); border: 1px solid var(--danger); }

    /* ===================== QUIZ ===================== */
    .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .section-title { font-size: 13px; font-weight: 600; color: var(--text-muted); }
    .quiz-status {
      display: inline-block; padding: 3px 8px;
      border-radius: 10px; font-size: 10px; font-weight: 700; text-transform: uppercase;
    }
    .quiz-status.idle { background: var(--border); color: var(--text-muted); }
    .quiz-status.active { background: var(--success); color: white; }
    .quiz-status.poll { background: var(--warning); color: white; }

    select {
      width: 100%; padding: 9px 10px;
      border: 1px solid var(--border); border-radius: 6px;
      background: var(--bg-dark); color: var(--text);
      font-size: 12px; margin-bottom: 10px;
    }
    select:focus { outline: none; border-color: var(--accent); }

    .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }

    /* ===================== ROUE ===================== */
    .roue-controls { display: none; margin-top: 12px; }
    .roue-controls.active { display: block; }
    .roue-action-btn { margin-bottom: 8px; }

    /* Mode cons√©cutif toggle */
    .consecutive-toggle {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px;
      background: rgba(59,130,246,0.08);
      border: 1px solid rgba(59,130,246,0.25);
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .consecutive-label { font-size: 12px; font-weight: 600; color: var(--text-muted); }
    .consecutive-label span { color: var(--accent); }

    /* ===================== LISTE PARTICIPANTS ROUE ===================== */
    .moderation-section {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .moderation-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg-dark);
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .moderation-header:hover { background: #1a2438; }

    .moderation-header-left {
      display: flex; align-items: center; gap: 8px;
      font-size: 12px; font-weight: 600; color: var(--text-muted);
    }
    .moderation-count {
      background: var(--accent);
      color: white;
      font-size: 10px; font-weight: 700;
      padding: 1px 6px; border-radius: 10px;
      min-width: 20px; text-align: center;
    }
    .moderation-chevron {
      font-size: 12px; color: var(--text-muted);
      transition: transform 0.25s;
    }
    .moderation-chevron.open { transform: rotate(180deg); }

    .moderation-body {
      display: none;
      padding: 10px;
      border-top: 1px solid var(--border);
      background: var(--bg-card);
    }
    .moderation-body.open { display: block; }

    /* Ajout manuel participant */
    .add-participant-row {
      display: flex; gap: 6px; margin-bottom: 10px;
    }
    .add-participant-row input {
      flex: 1; padding: 7px 10px;
      border: 1px solid var(--border); border-radius: 6px;
      background: var(--bg-dark); color: var(--text);
      font-size: 12px;
    }
    .add-participant-row input:focus { outline: none; border-color: var(--accent); }

    /* Liste participants */
    .participants-list { display: flex; flex-direction: column; gap: 4px; max-height: 260px; overflow-y: auto; }
    .participants-list::-webkit-scrollbar { width: 6px; }
    .participants-list::-webkit-scrollbar-track { background: var(--bg-dark); }
    .participants-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .participant-item {
      display: flex; align-items: center; gap: 6px;
      padding: 6px 8px;
      background: var(--bg-dark);
      border-radius: 6px;
      border: 1px solid transparent;
      transition: border-color 0.15s;
    }
    .participant-item:hover { border-color: var(--border); }

    .participant-name {
      flex: 1; font-size: 12px; font-weight: 600; color: var(--text);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .participant-edit-input {
      flex: 1; padding: 3px 6px;
      border: 1px solid var(--accent); border-radius: 4px;
      background: var(--bg-dark); color: var(--text);
      font-size: 12px; font-weight: 600;
    }
    .participant-edit-input:focus { outline: none; }

    .participant-actions { display: flex; gap: 4px; flex-shrink: 0; }

    .empty-participants {
      text-align: center; padding: 20px;
      font-size: 12px; color: var(--text-muted);
    }

    /* ===================== NUAGE MOD√âRATION ===================== */
    .nuage-word-item {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 8px;
      background: var(--bg-dark);
      border-radius: 6px; margin-bottom: 4px;
      border: 1px solid transparent;
      transition: border-color 0.15s;
    }
    .nuage-word-item:hover { border-color: var(--border); }

    .nuage-word-text {
      flex: 1; font-size: 12px; font-weight: 700; color: var(--text);
    }
    .nuage-word-count {
      font-size: 11px; color: var(--text-muted);
      background: var(--border); padding: 1px 6px;
      border-radius: 10px; font-weight: 600;
    }
    .nuage-word-actions { display: flex; gap: 4px; flex-shrink: 0; }

    .nuage-words-list { display: flex; flex-direction: column; max-height: 280px; overflow-y: auto; }
    .nuage-words-list::-webkit-scrollbar { width: 6px; }
    .nuage-words-list::-webkit-scrollbar-track { background: var(--bg-dark); }
    .nuage-words-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* ===================== TIMER ===================== */
    .timer-mode-toggle { display: flex; gap: 8px; margin-bottom: 12px; }
    .timer-mode-btn {
      flex: 1; padding: 10px;
      border: 2px solid var(--border);
      background: var(--bg-dark); color: var(--text-muted);
      border-radius: 6px; cursor: pointer;
      font-weight: 600; font-size: 12px; transition: all 0.2s;
    }
    .timer-mode-btn.active { border-color: var(--accent); background: var(--accent); color: white; }
    .timer-mode-btn:hover:not(.active) { background: var(--border); }

    .timer-preview-box {
      background: var(--bg-dark); padding: 16px; border-radius: 8px;
      text-align: center; margin-bottom: 12px; border: 1px solid var(--border);
    }
    .timer-preview-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600; }
    .timer-preview-time { font-size: 36px; font-weight: 900; color: var(--text); font-family: 'Courier New', monospace; font-variant-numeric: tabular-nums; }

    .timer-presets-title { font-size: 11px; margin-bottom: 8px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .timer-preset-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    .timer-preset-btn {
      flex: 1; min-width: 60px; padding: 8px 10px;
      background: var(--bg-dark); border: 1px solid var(--border);
      color: var(--text); border-radius: 4px; cursor: pointer;
      font-weight: 600; font-size: 11px; transition: all 0.2s;
    }
    .timer-preset-btn:hover { background: var(--border); border-color: var(--accent); }

    .timer-custom-title { font-size: 11px; margin-bottom: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .timer-digits { display: flex; justify-content: center; align-items: center; gap: 8px; background: var(--bg-dark); padding: 12px; border-radius: 8px; }
    .timer-digit-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .timer-digit-value { font-size: 24px; font-weight: 900; color: var(--text); font-family: 'Courier New', monospace; min-width: 32px; text-align: center; font-variant-numeric: tabular-nums; }
    .timer-digit-btns { display: flex; flex-direction: column; gap: 3px; }
    .timer-digit-btn {
      width: 32px; height: 24px; padding: 0;
      background: var(--border); border: 1px solid var(--border);
      color: var(--text); border-radius: 4px; cursor: pointer;
      font-size: 14px; font-weight: bold; transition: all 0.15s;
      display: flex; align-items: center; justify-content: center;
    }
    .timer-digit-btn:hover:not(:disabled) { background: #475569; }
    .timer-digit-btn:active { transform: scale(0.95); }
    .timer-digit-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .timer-digit-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px; }
    .timer-colon { font-size: 24px; font-weight: 900; color: var(--border); margin: 0 2px; padding-bottom: 28px; }
    .timer-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    .timer-controls button { font-size: 12px; }
    .timer-reset-btn { grid-column: 1 / -1; }

    /* ===================== COMMENTAIRES - LAYOUT 2 COL ===================== */
    .comments-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
    }
    .comments-overlay-status { display: flex; align-items: center; gap: 6px; }

    .comments-toggle-row {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-dark);
    }

    .comments-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--border);
      flex: 1;
    }

    .comments-col {
      background: var(--bg-card);
      padding: 12px;
      min-height: 480px;
      max-height: 560px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .comments-col::-webkit-scrollbar { width: 6px; }
    .comments-col::-webkit-scrollbar-track { background: var(--bg-dark); }
    .comments-col::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .comments-col-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 10px; padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    .comments-col-title {
      font-size: 13px; font-weight: 700; color: var(--text-muted);
      display: flex; align-items: center; gap: 6px;
    }
    .comments-col-actions { display: flex; gap: 6px; }

    .comments-list { flex: 1; display: flex; flex-direction: column; gap: 6px; }

    .comment-item {
      background: var(--bg-dark);
      border: 2px solid transparent;
      border-radius: 8px; padding: 10px;
      cursor: pointer; transition: all 0.15s;
      position: relative;
    }
    .comment-item:hover { border-color: var(--border); }
    .comment-item.selected { border-color: var(--success); box-shadow: 0 0 0 1px var(--success); }
    .comment-item.sent { opacity: 0.55; }
    .comment-item.displayed { opacity: 0.45; background: #141424; }

    .comment-author { font-size: 11px; font-weight: 700; color: var(--accent); margin-bottom: 3px; }
    .comment-text { font-size: 12px; color: var(--text); line-height: 1.4; margin-bottom: 6px; }
    .comment-actions { display: flex; gap: 5px; justify-content: flex-end; }
    .comment-sent-badge {
      position: absolute; top: 6px; right: 6px;
      color: var(--success); font-size: 14px; display: none;
    }
    .comment-item.sent .comment-sent-badge { display: block; }

    .comments-empty {
      text-align: center; padding: 30px 20px;
      color: var(--text-muted); font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="mainContainer" class="container narrow">

    <!-- Header -->
    <div class="header">
      <div class="auth-inputs">
        <input type="text" id="roomId" placeholder="Room ID (ex: DEMO_CLIENT)">
        <input type="password" id="roomKey" placeholder="Room Key (cl√© secr√®te)">
      </div>
      <div class="header-connect">
        <div id="statusDot" class="status-dot"></div>
        <button id="btnConnect" class="btn-connect">Connecter</button>
      </div>
    </div>

    <!-- Onglets -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('quiz', this)">‚ùì</button>
      <button class="tab" onclick="switchTab('nuage', this)">‚òÅÔ∏è</button>
      <button class="tab" onclick="switchTab('roue', this)">üé°</button>
      <button class="tab" onclick="switchTab('timer', this)">üïî</button>
      <button class="tab" onclick="switchTab('match', this)">‚ÜîÔ∏è</button>
      <button class="tab" onclick="switchTab('commentaires', this)">üí¨</button>
    </div>

    <!-- ===================== ONGLET QUIZ ===================== -->
    <div id="tabQuiz" class="tab-content active">
      <div class="overlay-status">
        <div class="overlay-voyant">
          <div id="statusQuizOnline" class="overlay-status-dot"></div>
          <span class="overlay-status-label">Connexion serveur</span>
        </div>
        <div class="overlay-voyant">
          <div id="statusQuizDisplay" class="overlay-status-dot"></div>
          <span class="overlay-status-label">Affichage dans OBS</span>
        </div>
      </div>
      <div class="separator"></div>

      <div class="quiz-header">
        <div class="section-title">Question / Sondage</div>
        <span id="quizStatus" class="quiz-status idle">Inactif</span>
      </div>

      <select id="questionSelect">
        <option value="">-- Connectez-vous d'abord --</option>
      </select>

      <div class="quiz-grid">
        <button class="btn-success" onclick="loadQuestion()">1. ‚ùì Charger</button>
        <button id="btnShowOptions" class="btn-secondary" onclick="showOptions()" disabled>2. üó≥Ô∏è Options</button>
        <button id="btnShowResults" class="btn-secondary" onclick="showResults()" disabled>3. üìä R√©sultats</button>
        <button id="btnRevealAnswer" class="btn-secondary" onclick="revealAnswer()" disabled>4. ‚úÖ R√©ponse</button>
      </div>
      <button id="btnResetQuiz" class="btn-danger" onclick="resetQuiz()" disabled>5. üîÑ R√©initialiser</button>
      <div id="messageQuiz" class="flash-msg"></div>
    </div>

    <!-- ===================== ONGLET NUAGE ===================== -->
    <div id="tabNuage" class="tab-content">
      <div class="overlay-status">
        <div class="overlay-voyant">
          <div id="statusNuageOnline" class="overlay-status-dot"></div>
          <span class="overlay-status-label">Connexion serveur</span>
        </div>
        <div class="overlay-voyant">
          <div id="statusNuageDisplay" class="overlay-status-dot"></div>
          <span class="overlay-status-label">Affichage dans OBS</span>
        </div>
      </div>
      <div class="separator"></div>

      <div class="toggle-container">
        <div class="toggle-label">
          <span class="icon">‚òÅÔ∏è</span>
          <span>Nuage de Mots</span>
        </div>
        <div id="toggleNuage" class="toggle-switch" onclick="toggleOverlay('nuage_de_mots')"></div>
      </div>

      <!-- Section mod√©ration NUAGE - collapsible -->
      <div class="moderation-section">
        <div class="moderation-header" onclick="toggleModerationNuage()">
          <div class="moderation-header-left">
            üîç Mod√©ration mots
            <span id="nuageWordCount" class="moderation-count">0</span>
          </div>
          <span id="nuageChevron" class="moderation-chevron">‚ñº</span>
        </div>
        <div id="nuageModerationBody" class="moderation-body">
          <div id="nuageWordsList" class="nuage-words-list">
            <div class="empty-participants">Aucun mot pour l'instant</div>
          </div>
          <div class="separator"></div>
          <button class="btn-danger" onclick="clearAllNuage()" style="font-size:12px; padding:8px;">
            üßπ Vider tout le nuage
          </button>
        </div>
      </div>

      <div id="messageNuage" class="flash-msg"></div>
    </div>

    <!-- ===================== ONGLET ROUE ===================== -->
    <div id="tabRoue" class="tab-content">
      <div class="overlay-status">
        <div class="overlay-voyant">
          <div id="statusRoueOnline" class="overlay-status-dot"></div>
          <span class="overlay-status-label">Connexion serveur</span>
        </div>
        <div class="overlay-voyant">
          <div id="statusRoueDisplay" class="overlay-status-dot"></div>
          <span class="overlay-status-label">Affichage dans OBS</span>
        </div>
      </div>
      <div class="separator"></div>

      <div class="toggle-container">
        <div class="toggle-label">
          <span class="icon">üé°</span>
          <span>Roue Loto</span>
        </div>
        <div id="toggleRoue" class="toggle-switch" onclick="toggleRoueOverlay()"></div>
      </div>

      <div id="roueControls" class="roue-controls">

        <!-- Mode cons√©cutif -->
        <div class="consecutive-toggle">
          <div class="consecutive-label">
            üîÅ Mode cons√©cutif ‚Äî <span>gagnant retir√© apr√®s chaque spin</span>
          </div>
          <div id="toggleConsecutif" class="toggle-switch" style="width:38px; height:22px;"
               onclick="toggleConsecutifMode()"></div>
        </div>

        <!-- Toggle Collecte -->
        <div class="toggle-container" style="margin-bottom: 10px;">
          <div class="toggle-label">
            <span style="font-size: 13px;">üìù Fermer collecte pour lancer</span>
          </div>
          <div id="toggleCollecte" class="toggle-switch" onclick="toggleCollecte()"></div>
        </div>

        <!-- Lancer / Reset -->
        <button class="btn-success roue-action-btn" onclick="spinRoue()">üé° Lancer la roue</button>
        <button class="btn-danger" onclick="resetRoue()">üîÑ Reset Roue</button>

        <!-- Section mod√©ration ROUE - collapsible -->
        <div class="moderation-section" style="margin-top:12px;">
          <div class="moderation-header" onclick="toggleModerationRoue()">
            <div class="moderation-header-left">
              üë• Participants
              <span id="roueParticipantCount" class="moderation-count">0</span>
            </div>
            <span id="roueChevron" class="moderation-chevron">‚ñº</span>
          </div>
          <div id="roueModerationBody" class="moderation-body">
            <!-- Ajout manuel -->
            <div class="add-participant-row">
              <input type="text" id="newParticipantInput" placeholder="Ajouter un nom‚Ä¶" maxlength="40"
                     onkeydown="if(event.key==='Enter') addParticipantManual()">
              <button class="btn-primary btn-small" onclick="addParticipantManual()" style="padding:7px 12px;">‚ûï Ajouter</button>
            </div>
            <!-- Liste -->
            <div id="participantsList" class="participants-list">
              <div class="empty-participants">Aucun participant pour l'instant</div>
            </div>
          </div>
        </div>

      </div>

      <div id="messageRoue" class="flash-msg"></div>
    </div>

    <!-- ===================== ONGLET COMMENTAIRES ===================== -->
    <div id="tabCommentaires" class="tab-content comments-tab">

      <!-- Header commentaires -->
      <div class="comments-header">
        <div class="comments-overlay-status">
          <div class="overlay-voyant">
            <div id="statusCommOnline" class="overlay-status-dot"></div>
            <span class="overlay-status-label">Connexion</span>
          </div>
          <div class="overlay-voyant">
            <div id="statusCommDisplay" class="overlay-status-dot"></div>
            <span class="overlay-status-label">Affichage</span>
          </div>
        </div>
        <div style="flex:1;"></div>
        <div id="messageCommentaires" class="flash-msg" style="margin-top:0; flex:0 0 auto;"></div>
      </div>

      <!-- Toggle activation overlay commentaires -->
      <div class="comments-toggle-row">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div style="font-size:13px; font-weight:600; display:flex; align-items:center; gap:8px;">
            üí¨ <span>Commentaires</span>
          </div>
          <div id="toggleCommentaires" class="toggle-switch" onclick="toggleOverlay('commentaires')"></div>
        </div>
      </div>

      <!-- 2 colonnes Flux / En attente -->
      <div class="comments-columns">
        <!-- Flux -->
        <div class="comments-col">
          <div class="comments-col-header">
            <div class="comments-col-title">üì• FLUX</div>
            <div class="comments-col-actions">
              <button class="btn-small btn-danger" onclick="resetFlux()">üßπ Nettoyer</button>
            </div>
          </div>
          <div id="fluxList" class="comments-list">
            <div class="comments-empty">Aucun message pour l'instant</div>
          </div>
        </div>

        <!-- En attente -->
        <div class="comments-col">
          <div class="comments-col-header">
            <div class="comments-col-title">üì∫ EN ATTENTE</div>
            <div class="comments-col-actions">
              <button class="btn-small btn-success" onclick="showComment()">üëÅÔ∏è Afficher</button>
              <button class="btn-small btn-secondary" onclick="hideComment()">üôà Masquer</button>
              <button class="btn-small btn-danger" onclick="resetQueue()">üßπ Vider</button>
            </div>
          </div>
          <div id="queueList" class="comments-list">
            <div class="comments-empty">Aucun commentaire en attente</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== ONGLET TIMER ===================== -->
    <div id="tabTimer" class="tab-content">
      <div class="overlay-status">
        <div class="overlay-voyant">
          <div id="statusTimerOnline" class="overlay-status-dot"></div>
          <span class="overlay-status-label">Connexion serveur</span>
        </div>
        <div class="overlay-voyant">
          <div id="statusTimerDisplay" class="overlay-status-dot"></div>
          <span class="overlay-status-label">Affichage dans OBS</span>
        </div>
      </div>
      <div class="separator"></div>

      <div class="timer-mode-toggle">
        <button class="timer-mode-btn active" data-mode="timer" onclick="timerSetMode('timer')">Compte √† rebours</button>
        <button class="timer-mode-btn" data-mode="chrono" onclick="timerSetMode('chrono')">Chronom√®tre</button>
      </div>

      <div class="timer-preview-box">
        <div class="timer-preview-label">Temps configur√©</div>
        <div class="timer-preview-time" id="timerPreview">00:00</div>
      </div>

      <div class="timer-controls">
        <button class="btn-success" onclick="timerStart()">‚ñ∂Ô∏è Start</button>
        <button class="btn-secondary" onclick="timerPause()">‚è∏Ô∏è Pause</button>
        <button class="btn-danger timer-reset-btn" onclick="timerReset()">üîÑ Reset</button>
      </div>

      <!-- Presets rapides ‚Äî collapsible -->
      <div class="moderation-section" style="margin-top:12px;">
        <div class="moderation-header" onclick="toggleTimerPresets()">
          <div class="moderation-header-left">‚ö° Presets rapides</div>
          <span id="timerPresetsChevron" class="moderation-chevron">‚ñº</span>
        </div>
        <div id="timerPresetsBody" class="moderation-body">
          <div class="timer-preset-row" style="margin-top:4px;">
            <button class="timer-preset-btn" onclick="timerPreset(10)">10s</button>
            <button class="timer-preset-btn" onclick="timerPreset(20)">20s</button>
            <button class="timer-preset-btn" onclick="timerPreset(30)">30s</button>
          </div>
          <div class="timer-preset-row">
            <button class="timer-preset-btn" onclick="timerPreset(60)">1min</button>
            <button class="timer-preset-btn" onclick="timerPreset(120)">2min</button>
            <button class="timer-preset-btn" onclick="timerPreset(300)">5min</button>
          </div>
          <div class="timer-preset-row">
            <button class="timer-preset-btn" onclick="timerPreset(900)">15min</button>
            <button class="timer-preset-btn" onclick="timerPreset(1200)">20min</button>
            <button class="timer-preset-btn" onclick="timerPreset(1800)">30min</button>
          </div>
        </div>
      </div>

      <!-- Personnalis√© ‚Äî collapsible -->
      <div class="moderation-section" style="margin-top:8px;">
        <div class="moderation-header" onclick="toggleTimerCustom()">
          <div class="moderation-header-left">üéõÔ∏è Personnalis√©</div>
          <span id="timerCustomChevron" class="moderation-chevron">‚ñº</span>
        </div>
        <div id="timerCustomBody" class="moderation-body">
          <div class="timer-digits" style="margin-top:4px;">
            <div class="timer-digit-group">
              <div class="timer-digit-btns">
                <button class="timer-digit-btn" onclick="timerAdjust(600)">+</button>
                <button class="timer-digit-btn" onclick="timerAdjust(-600)">‚àí</button>
              </div>
              <div class="timer-digit-value" id="timerDigitM10">0</div>
              <div class="timer-digit-label">Diz min</div>
            </div>
            <div class="timer-digit-group">
              <div class="timer-digit-btns">
                <button class="timer-digit-btn" onclick="timerAdjust(60)">+</button>
                <button class="timer-digit-btn" onclick="timerAdjust(-60)">‚àí</button>
              </div>
              <div class="timer-digit-value" id="timerDigitM1">0</div>
              <div class="timer-digit-label">Unit min</div>
            </div>
            <div class="timer-colon">:</div>
            <div class="timer-digit-group">
              <div class="timer-digit-btns">
                <button class="timer-digit-btn" onclick="timerAdjust(10)">+</button>
                <button class="timer-digit-btn" onclick="timerAdjust(-10)">‚àí</button>
              </div>
              <div class="timer-digit-value" id="timerDigitS10">0</div>
              <div class="timer-digit-label">Diz sec</div>
            </div>
            <div class="timer-digit-group">
              <div class="timer-digit-btns">
                <button class="timer-digit-btn" onclick="timerAdjust(1)">+</button>
                <button class="timer-digit-btn" onclick="timerAdjust(-1)">‚àí</button>
              </div>
              <div class="timer-digit-value" id="timerDigitS1">0</div>
              <div class="timer-digit-label">Unit sec</div>
            </div>
          </div>
        </div>
      </div>

      <div id="messageTimer" class="flash-msg" style="margin-top:12px;"></div>
    </div>

    <!-- ===================== ONGLET MATCH ===================== -->
    <div id="tabMatch" class="tab-content">
      <div class="overlay-status">
        <div class="overlay-voyant">
          <div id="statusMatchOnline" class="overlay-status-dot"></div>
          <span class="overlay-status-label">Connexion serveur</span>
        </div>
        <div class="overlay-voyant">
          <div id="statusMatchDisplay" class="overlay-status-dot"></div>
          <span class="overlay-status-label">Affichage dans OBS</span>
        </div>
      </div>
      <div class="separator"></div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
        <div style="text-align:center;">
          <div style="font-size:16px; font-weight:700; color:#3b82f6; margin-bottom:12px;">√âQUIPE A</div>
          <div style="font-size:48px; font-weight:900; color:var(--text); margin-bottom:12px;" id="matchScoreA">0</div>
          <div style="display:flex; gap:8px; justify-content:center;">
            <button class="btn-danger" style="width:50px; height:50px; font-size:24px;" onclick="matchAdjustScore('A',-1)">‚àí</button>
            <button class="btn-success" style="width:50px; height:50px; font-size:24px;" onclick="matchAdjustScore('A',1)">+</button>
          </div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:16px; font-weight:700; color:#ef4444; margin-bottom:12px;">√âQUIPE B</div>
          <div style="font-size:48px; font-weight:900; color:var(--text); margin-bottom:12px;" id="matchScoreB">0</div>
          <div style="display:flex; gap:8px; justify-content:center;">
            <button class="btn-danger" style="width:50px; height:50px; font-size:24px;" onclick="matchAdjustScore('B',-1)">‚àí</button>
            <button class="btn-success" style="width:50px; height:50px; font-size:24px;" onclick="matchAdjustScore('B',1)">+</button>
          </div>
        </div>
      </div>
      <button class="btn-danger" onclick="matchReset()">üîÑ R√©initialiser les scores</button>
      <div id="messageMatch" class="flash-msg"></div>
    </div>

  </div><!-- /container -->

  <script>
    const SERVER_URL = "https://magic-digital-impact-live.onrender.com";

    // ===================== STATE =====================
    let socket = null;
    let connected = false;
    let currentRoom = "";
    let currentKey = "";
    let questions = [];
    let currentQuestionType = null;

    let overlayStates = {
      nuage_de_mots: false,
      roue_loto: false,
      roue_collecte: false,
      quiz_ou_sondage: false,
      timer_chrono: false,
      commentaires: false
    };

    // Timer
    let timerMode = "timer";
    let timerSeconds = 60;
    let timerRunning = false;

    // Match
    let matchScoreA = 0;
    let matchScoreB = 0;

    // Nuage ‚Äî mots locaux (mis √† jour depuis overlay:state)
    let nuageWords = {}; // { mot: count }

    // Roue ‚Äî participants locaux
    let roueParticipants = []; // [{ name, key }] ou [string]
    let consecutifMode = false;

    // Commentaires
    let fluxMessages = [];
    let queueMessages = [];
    let selectedQueueId = null;

    // ===================== HELPERS =====================
    const $ = (id) => document.getElementById(id);
    const pad2 = (n) => String(n).padStart(2, "0");

    // Mise √† jour d'un voyant individuel (online ou display)
    function setDot(id, active) {
      const el = $(id);
      if (!el) return;
      if (active) {
        el.classList.add("on");
      } else {
        el.classList.remove("on");
      }
    }

    // Correspondance overlay ‚Üí IDs des deux voyants
    const OVERLAY_DOTS = {
      "quiz_ou_sondage": { online: "statusQuizOnline",   display: "statusQuizDisplay"   },
      "nuage_de_mots":   { online: "statusNuageOnline",  display: "statusNuageDisplay"  },
      "roue_loto":       { online: "statusRoueOnline",   display: "statusRoueDisplay"   },
      "commentaires":    { online: "statusCommOnline",   display: "statusCommDisplay"   },
      "timer_chrono":    { online: "statusTimerOnline",  display: "statusTimerDisplay"  },
      "match_equipes":   { online: "statusMatchOnline",  display: "statusMatchDisplay"  }
    };

    function updateOverlayDots(overlay, { online, displaying } = {}) {
      const dots = OVERLAY_DOTS[overlay];
      if (!dots) return;
      if (online !== undefined)     setDot(dots.online,  online);
      if (displaying !== undefined) setDot(dots.display, displaying);
    }

    // R√©trocompat : certains endroits appellent encore updateStatusDot ‚Äî on le garde vide
    function updateStatusDot() {}

    function flash(tabId, text, type = "success") {
      const el = $("message" + tabId.charAt(0).toUpperCase() + tabId.slice(1));
      if (!el) return;
      el.textContent = text;
      el.className = `flash-msg ${type} show`;
      clearTimeout(el._timer);
      el._timer = setTimeout(() => el.classList.remove("show"), 3000);
    }

    // ===================== ONGLETS =====================
    let currentTab = "quiz";

    function switchTab(tab, btnEl) {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));

      if (btnEl) btnEl.classList.add("active");
      const contentEl = $("tab" + tab.charAt(0).toUpperCase() + tab.slice(1));
      if (contentEl) contentEl.classList.add("active");

      currentTab = tab;

      // Redimensionner le container selon l'onglet
      const container = $("mainContainer");
      if (tab === "commentaires") {
        container.classList.remove("narrow");
        container.classList.add("wide");
      } else {
        container.classList.remove("wide");
        container.classList.add("narrow");
      }
    }

    // ===================== CONNEXION =====================
    async function connect() {
      const room = $("roomId").value.trim();
      const key = $("roomKey").value.trim();

      if (!room || !key) { flash("quiz", "‚ö†Ô∏è Room ID et Key requis", "error"); return; }

      currentRoom = room;
      currentKey = key;

      if (socket) socket.disconnect();

      socket = io(SERVER_URL, { transports: ["websocket", "polling"], reconnection: true });

      socket.on("connect", () => {
        console.log("‚úÖ [REMOTE] Connect√©");
        connected = true;
        $("statusDot").className = "status-dot connected";
        socket.emit("rejoindre_salle", currentRoom);
        loadQuestionCatalog();
        flash("quiz", "‚úÖ Connect√©", "success");

        // Activer timer et match en arri√®re-plan
        setTimeout(() => socket.emit("control:activate_overlay", { room: currentRoom, overlay: "timer_chrono" }), 500);
        setTimeout(() => socket.emit("control:activate_overlay", { room: currentRoom, overlay: "match_equipes" }), 700);
      });

      socket.on("connect_error", () => {
        connected = false;
        $("statusDot").className = "status-dot";
        flash("quiz", "‚ùå Erreur connexion", "error");
      });

      socket.on("disconnect", () => {
        connected = false;
        $("statusDot").className = "status-dot";
      });

      socket.on("overlay:state", (payload) => {
        console.log("üì° [REMOTE] √âtat:", payload.overlay, payload.state);
        handleOverlayState(payload);
      });

      // ‚úÖ NOUVEAU V3.5 : √©coute des voyants de pr√©sence en temps r√©el
      socket.on("overlay:presence", (payload) => {
        const { overlay, online, displaying } = payload;
        console.log(`üì° [REMOTE] Pr√©sence: ${overlay} online=${online} displaying=${displaying}`);
        updateOverlayDots(overlay, { online, displaying });
      });

      socket.on("overlay:forbidden", () => {
        flash("quiz", "‚ùå Acc√®s refus√©", "error");
        connected = false;
        $("statusDot").className = "status-dot";
      });
    }

    // ===================== √âTATS OVERLAY =====================
    function handleOverlayState(payload) {
      const { overlay, state, data } = payload;

      if (overlay === "nuage_de_mots") {
        const isActive = state === "active";
        overlayStates.nuage_de_mots = isActive;
        $("toggleNuage").className = isActive ? "toggle-switch active" : "toggle-switch";
        // Voyant affichage mis √† jour par overlay:presence depuis l'overlay lui-m√™me
        // On met √† jour ici uniquement si l'overlay est idle (on sait qu'il n'affiche rien)
        if (!isActive) updateOverlayDots(overlay, { displaying: false });

        if (isActive && data && data.words) {
          nuageWords = { ...data.words };
        } else if (!isActive) {
          nuageWords = {};
        }
        renderNuageWords();
      }

      if (overlay === "roue_loto") {
        const isActive = state !== "idle";
        overlayStates.roue_loto = isActive;
        $("toggleRoue").className = isActive ? "toggle-switch active" : "toggle-switch";
        $("roueControls").className = isActive ? "roue-controls active" : "roue-controls";
        if (!isActive) updateOverlayDots(overlay, { displaying: false });

        if (data && data.participants) {
          roueParticipants = data.participants.map(p => typeof p === "string" ? { name: p, key: p.toLowerCase() } : p);
        } else if (!isActive) {
          roueParticipants = [];
        }
        renderParticipants();

        if (isActive && !overlayStates.roue_collecte) {
          if (state === "active") {
            setTimeout(() => startCollect(), 300);
          }
        }

        if (state === "collecting") overlayStates.roue_collecte = true;
        if (state === "ready") overlayStates.roue_collecte = false;
        updateCollecteToggle(state === "collecting");
      }

      if (overlay === "quiz_ou_sondage") {
        const isActive = state !== "idle";
        const questionType = data?.question?.type || null;
        updateQuizUI(isActive, questionType);
        if (!isActive) updateOverlayDots(overlay, { displaying: false });
      }

      if (overlay === "timer_chrono") {
        if (state === "idle") updateOverlayDots(overlay, { displaying: false });
      }

      if (overlay === "match_equipes") {
        if (state === "idle") updateOverlayDots(overlay, { displaying: false });
        if (data) {
          if (data.teamA) { matchScoreA = data.teamA.score || 0; $("matchScoreA").textContent = matchScoreA; }
          if (data.teamB) { matchScoreB = data.teamB.score || 0; $("matchScoreB").textContent = matchScoreB; }
        }
      }

      if (overlay === "commentaires") {
        const isActive = state !== "idle";
        overlayStates.commentaires = isActive;
        $("toggleCommentaires").className = isActive ? "toggle-switch active" : "toggle-switch";
        if (!isActive) updateOverlayDots(overlay, { displaying: false });

        if (data) {
          if (data.flux)  fluxMessages  = data.flux;
          if (data.queue) queueMessages = data.queue;
        }
        renderFlux();
        renderQueue();
      }
    }

    // ===================== QUIZ =====================
    function updateQuizUI(isActive, questionType) {
      overlayStates.quiz_ou_sondage = isActive;
      currentQuestionType = questionType;
      const status = $("quizStatus");

      if (isActive) {
        status.textContent = questionType === "poll" ? "Sondage" : "Quiz";
        status.className = questionType === "poll" ? "quiz-status poll" : "quiz-status active";
        $("btnShowOptions").disabled = false;
        $("btnShowResults").disabled = false;
        $("btnResetQuiz").disabled = false;
        $("btnRevealAnswer").disabled = questionType === "poll";
      } else {
        status.textContent = "Inactif"; status.className = "quiz-status idle";
        $("btnShowOptions").disabled = true;
        $("btnShowResults").disabled = true;
        $("btnRevealAnswer").disabled = true;
        $("btnResetQuiz").disabled = true;
      }
    }

    async function loadQuestionCatalog() {
      try {
        const res = await fetch(`${SERVER_URL}/debug/questions?room=${currentRoom}`);
        const json = await res.json();
        questions = json.data || [];
        const select = $("questionSelect");
        select.innerHTML = '<option value="">-- Choisir --</option>';
        questions.forEach(q => {
          const opt = document.createElement("option");
          opt.value = q.question_key;
          opt.textContent = `${q.question_key} - ${q.prompt}`;
          opt.dataset.type = q.type;
          select.appendChild(opt);
        });
      } catch (e) { console.error("‚ùå Catalogue:", e); }
    }

    function loadQuestion() {
      if (!connected) { flash("quiz", "‚ùå Connectez-vous", "error"); return; }
      const questionKey = $("questionSelect").value;
      if (!questionKey) { flash("quiz", "‚ö†Ô∏è Choisissez une question", "error"); return; }
      if (overlayStates.nuage_de_mots) socket.emit("control:deactivate_overlay", { room: currentRoom, overlay: "nuage_de_mots" });
      if (overlayStates.roue_loto) socket.emit("control:deactivate_overlay", { room: currentRoom, overlay: "roue_loto" });
      socket.emit("control:load_question", { room: currentRoom, overlay: "quiz_ou_sondage", question_key: questionKey });
    }
    function showOptions() { if (!connected) return; socket.emit("control:show_options", { room: currentRoom, overlay: "quiz_ou_sondage" }); }
    function showResults() { if (!connected) return; socket.emit("control:set_state", { room: currentRoom, overlay: "quiz_ou_sondage", state: "results" }); }
    function revealAnswer() { if (!connected || currentQuestionType === "poll") return; socket.emit("control:set_state", { room: currentRoom, overlay: "quiz_ou_sondage", state: "reveal" }); }
    function resetQuiz() { if (!connected) return; socket.emit("control:idle", { room: currentRoom, overlay: "quiz_ou_sondage" }); }

    // ===================== TOGGLE OVERLAY G√âN√âRIQUE =====================
    function toggleOverlay(overlayName) {
      if (!connected) { flash(overlayName === "nuage_de_mots" ? "nuage" : overlayName, "‚ùå Connectez-vous", "error"); return; }

      const isActive = overlayStates[overlayName];
      if (isActive) {
        socket.emit("control:deactivate_overlay", { room: currentRoom, overlay: overlayName });
      } else {
        // D√©sactiver concurrents (sauf timer/match/commentaires)
        if (overlayName === "nuage_de_mots" && overlayStates.roue_loto)
          socket.emit("control:deactivate_overlay", { room: currentRoom, overlay: "roue_loto" });
        if (overlayName === "nuage_de_mots" && overlayStates.quiz_ou_sondage)
          socket.emit("control:idle", { room: currentRoom, overlay: "quiz_ou_sondage" });
        socket.emit("control:activate_overlay", { room: currentRoom, overlay: overlayName });
      }
    }

    // ===================== NUAGE ‚Äî MOD√âRATION =====================
    let nuageModerationOpen = false;

    function toggleModerationNuage() {
      nuageModerationOpen = !nuageModerationOpen;
      $("nuageModerationBody").className = "moderation-body" + (nuageModerationOpen ? " open" : "");
      $("nuageChevron").className = "moderation-chevron" + (nuageModerationOpen ? " open" : "");
    }

    function renderNuageWords() {
      const list = $("nuageWordsList");
      const words = Object.entries(nuageWords).sort((a, b) => b[1] - a[1]);
      $("nuageWordCount").textContent = words.length;

      if (!words.length) {
        list.innerHTML = '<div class="empty-participants">Aucun mot pour l\'instant</div>';
        return;
      }

      list.innerHTML = words.map(([word, count]) => `
        <div class="nuage-word-item">
          <span class="nuage-word-text">${escHtml(word)}</span>
          <span class="nuage-word-count">${count}√ó</span>
          <div class="nuage-word-actions">
            <button class="btn-small btn-success" onclick="nuageIncrementWord('${escJs(word)}')" title="+1 vote">+1</button>
            <button class="btn-small btn-danger" onclick="nuageRemoveWord('${escJs(word)}')" title="Supprimer">‚ùå</button>
          </div>
        </div>
      `).join("");
    }

    function nuageRemoveWord(word) {
      if (!connected) return;
      socket.emit("control:nuage_remove_word", { room: currentRoom, word });
      // Mise √† jour locale optimiste
      delete nuageWords[word];
      renderNuageWords();
      console.log(`‚ùå [NUAGE] Mot supprim√©: ${word}`);
    }

    function nuageIncrementWord(word) {
      if (!connected) return;
      socket.emit("control:nuage_word_increment", { room: currentRoom, word });
      // Mise √† jour locale optimiste
      nuageWords[word] = (nuageWords[word] || 0) + 1;
      renderNuageWords();
      console.log(`+1 [NUAGE] Mot incr√©ment√©: ${word}`);
    }

    function clearAllNuage() {
      if (!connected) return;
      if (!confirm("Vider tout le nuage ?")) return;
      socket.emit("control:nuage_clear_all", { room: currentRoom });
      nuageWords = {};
      renderNuageWords();
    }

    // ===================== ROUE =====================
    function toggleRoueOverlay() {
      if (!connected) { flash("roue", "‚ùå Connectez-vous", "error"); return; }
      const isActive = overlayStates.roue_loto;
      if (isActive) {
        socket.emit("control:deactivate_overlay", { room: currentRoom, overlay: "roue_loto" });
        updateCollecteToggle(false);
        roueParticipants = [];
        renderParticipants();
      } else {
        if (overlayStates.nuage_de_mots) socket.emit("control:deactivate_overlay", { room: currentRoom, overlay: "nuage_de_mots" });
        if (overlayStates.quiz_ou_sondage) socket.emit("control:idle", { room: currentRoom, overlay: "quiz_ou_sondage" });
        socket.emit("control:activate_overlay", { room: currentRoom, overlay: "roue_loto" });
      }
    }

    function toggleCollecte() {
      if (!connected || !overlayStates.roue_loto) return;
      if (overlayStates.roue_collecte) stopCollect(); else startCollect();
    }

    function startCollect() {
      if (!connected || !overlayStates.roue_loto) return;
      socket.emit("roue:start_collect", { room: currentRoom });
      updateCollecteToggle(true);
      flash("roue", "üìù Collecte ouverte", "success");
    }

    function stopCollect() {
      if (!connected || !overlayStates.roue_loto) return;
      socket.emit("roue:stop_collect", { room: currentRoom });
      updateCollecteToggle(false);
      flash("roue", "üîí Collecte ferm√©e", "success");
    }

    function updateCollecteToggle(isActive) {
      overlayStates.roue_collecte = isActive;
      $("toggleCollecte").className = isActive ? "toggle-switch active" : "toggle-switch";
    }

    function spinRoue() {
      if (!connected || !overlayStates.roue_loto) return;
      socket.emit("roue:spin", { room: currentRoom });
      flash("roue", "üé° Roue lanc√©e !", "success");
    }

    function resetRoue() {
      if (!connected || !overlayStates.roue_loto) return;
      socket.emit("roue:reset", { room: currentRoom });
      updateCollecteToggle(false);
      roueParticipants = [];
      renderParticipants();
      flash("roue", "üîÑ Roue r√©initialis√©e", "success");
    }

    // Mode cons√©cutif
    function toggleConsecutifMode() {
      consecutifMode = !consecutifMode;
      $("toggleConsecutif").className = consecutifMode ? "toggle-switch active" : "toggle-switch";
      // Informer le serveur
      if (connected) {
        socket.emit("roue:set_consecutif", { room: currentRoom, enabled: consecutifMode });
      }
      flash("roue", consecutifMode ? "üîÅ Mode cons√©cutif ON" : "üîÅ Mode cons√©cutif OFF", "success");
    }

    // ===================== ROUE ‚Äî MOD√âRATION =====================
    let roueModerationOpen = false;

    function toggleModerationRoue() {
      roueModerationOpen = !roueModerationOpen;
      $("roueModerationBody").className = "moderation-body" + (roueModerationOpen ? " open" : "");
      $("roueChevron").className = "moderation-chevron" + (roueModerationOpen ? " open" : "");
    }

    function renderParticipants() {
      const list = $("participantsList");
      $("roueParticipantCount").textContent = roueParticipants.length;

      if (!roueParticipants.length) {
        list.innerHTML = '<div class="empty-participants">Aucun participant pour l\'instant</div>';
        return;
      }

      list.innerHTML = roueParticipants.map((p, idx) => {
        const name = typeof p === "string" ? p : p.name;
        return `
          <div class="participant-item" id="pitem-${idx}">
            <span class="participant-name" id="pname-${idx}">${escHtml(name)}</span>
            <div class="participant-actions">
              <button class="btn-small btn-secondary" onclick="startEditParticipant(${idx})" title="√âditer">‚úèÔ∏è</button>
              <button class="btn-small btn-danger" onclick="removeParticipant(${idx})" title="Supprimer">‚ùå</button>
            </div>
          </div>
        `;
      }).join("");
    }

    function startEditParticipant(idx) {
      const nameEl = $(`pname-${idx}`);
      const currentName = nameEl.textContent;

      // Remplacer le span par un input
      nameEl.outerHTML = `<input class="participant-edit-input" id="pedit-${idx}"
        value="${escHtml(currentName)}"
        onkeydown="handleEditKey(event, ${idx})"
        onblur="cancelEdit(${idx}, '${escJs(currentName)}')" />`;

      const input = $(`pedit-${idx}`);
      input.focus();
      input.select();
    }

    function handleEditKey(event, idx) {
      if (event.key === "Enter") { commitEdit(idx); }
      if (event.key === "Escape") {
        const input = $(`pedit-${idx}`);
        const original = input.defaultValue;
        cancelEdit(idx, original);
      }
    }

    function commitEdit(idx) {
      const input = $(`pedit-${idx}`);
      if (!input) return;
      const newName = input.value.trim();
      const oldName = typeof roueParticipants[idx] === "string" ? roueParticipants[idx] : roueParticipants[idx].name;

      if (!newName || newName === oldName) { cancelEdit(idx, oldName); return; }

      if (connected) {
        socket.emit("control:roue_edit_participant", {
          room: currentRoom,
          index: idx,
          oldName,
          newName
        });
      }

      // Mise √† jour locale
      if (typeof roueParticipants[idx] === "string") {
        roueParticipants[idx] = newName;
      } else {
        roueParticipants[idx] = { name: newName, key: newName.toLowerCase() };
      }
      renderParticipants();
      flash("roue", `‚úèÔ∏è "${oldName}" ‚Üí "${newName}"`, "success");
    }

    function cancelEdit(idx, originalName) {
      // Remettre le span
      const item = $(`pitem-${idx}`);
      if (!item) return;
      const input = $(`pedit-${idx}`);
      if (!input) return;
      input.outerHTML = `<span class="participant-name" id="pname-${idx}">${escHtml(originalName)}</span>`;
    }

    function removeParticipant(idx) {
      if (!connected) return;
      const p = roueParticipants[idx];
      const name = typeof p === "string" ? p : p.name;
      socket.emit("control:roue_remove_participant", { room: currentRoom, name, index: idx });
      // Mise √† jour locale optimiste
      roueParticipants.splice(idx, 1);
      renderParticipants();
      console.log(`‚ùå [ROUE] Participant supprim√©: ${name}`);
    }

    function addParticipantManual() {
      if (!connected) { flash("roue", "‚ùå Connectez-vous", "error"); return; }
      const input = $("newParticipantInput");
      const name = input.value.trim();
      if (!name) return;

      socket.emit("control:roue_add_participant_manual", { room: currentRoom, name });

      // Mise √† jour locale optimiste
      const key = name.toLowerCase();
      if (!roueParticipants.some(p => (typeof p === "string" ? p : p.name).toLowerCase() === key)) {
        roueParticipants.push({ name, key });
        renderParticipants();
      }

      input.value = "";
      input.focus();
      flash("roue", `‚ûï "${name}" ajout√©`, "success");
    }

    // ===================== COMMENTAIRES =====================
    function renderFlux() {
      const list = $("fluxList");
      if (!fluxMessages.length) {
        list.innerHTML = '<div class="comments-empty">Aucun message pour le moment</div>';
        return;
      }
      list.innerHTML = fluxMessages.map(msg => `
        <div class="comment-item ${msg.sent ? 'sent' : ''}" data-id="${msg.id}">
          <div class="comment-sent-badge">‚úî</div>
          <div class="comment-author">${escHtml(msg.author)}</div>
          <div class="comment-text">${escHtml(msg.text)}</div>
          <div class="comment-actions">
            <button class="btn-small btn-danger" onclick="deleteFluxMsg('${escJs(msg.id)}')">‚ùå</button>
            <button class="btn-small btn-primary" onclick="sendToQueue('${escJs(msg.id)}')" ${msg.sent ? 'disabled' : ''}>‚Üí Attente</button>
          </div>
        </div>
      `).join("");
    }

    function renderQueue() {
      const list = $("queueList");
      if (!queueMessages.length) {
        list.innerHTML = '<div class="comments-empty">Aucun commentaire en attente</div>';
        return;
      }
      list.innerHTML = queueMessages.map(msg => `
        <div class="comment-item ${msg.displayed ? 'displayed' : ''} ${selectedQueueId === msg.id ? 'selected' : ''}"
             onclick="selectQueueMsg('${escJs(msg.id)}')">
          <div class="comment-author">${escHtml(msg.author)}</div>
          <div class="comment-text">${escHtml(msg.text)}</div>
          <div class="comment-actions">
            <button class="btn-small btn-danger" onclick="event.stopPropagation(); deleteQueueMsg('${escJs(msg.id)}')">‚ùå</button>
          </div>
        </div>
      `).join("");
    }

    function sendToQueue(msgId) {
      if (!connected) return;
      socket.emit("control:comment_to_queue", { room: currentRoom, messageId: msgId });
    }

    function deleteFluxMsg(msgId) {
      if (!connected) return;
      socket.emit("control:comment_delete", { room: currentRoom, column: "flux", messageId: msgId });
    }

    function resetFlux() {
      if (!connected) return;
      if (!confirm("Vider toute la colonne FLUX ?")) return;
      socket.emit("control:comment_reset_flux", { room: currentRoom });
    }

    function selectQueueMsg(msgId) {
      selectedQueueId = msgId;
      renderQueue();
    }

    function showComment() {
      if (!connected || !selectedQueueId) { flash("commentaires", "‚ö†Ô∏è S√©lectionnez un message", "error"); return; }
      socket.emit("control:comment_show", { room: currentRoom, messageId: selectedQueueId });
    }

    function hideComment() {
      if (!connected) return;
      socket.emit("control:comment_hide", { room: currentRoom });
    }

    function deleteQueueMsg(msgId) {
      if (!connected) return;
      socket.emit("control:comment_delete", { room: currentRoom, column: "queue", messageId: msgId });
      if (selectedQueueId === msgId) selectedQueueId = null;
    }

    function resetQueue() {
      if (!connected) return;
      if (!confirm("Vider toute la colonne EN ATTENTE ?")) return;
      socket.emit("control:comment_reset_queue", { room: currentRoom });
      selectedQueueId = null;
    }

    // ===================== TIMER ‚Äî COLLAPSIBLES =====================
    let timerPresetsOpen = false;
    let timerCustomOpen = false;

    function toggleTimerPresets() {
      timerPresetsOpen = !timerPresetsOpen;
      $("timerPresetsBody").className = "moderation-body" + (timerPresetsOpen ? " open" : "");
      $("timerPresetsChevron").className = "moderation-chevron" + (timerPresetsOpen ? " open" : "");
    }

    function toggleTimerCustom() {
      timerCustomOpen = !timerCustomOpen;
      $("timerCustomBody").className = "moderation-body" + (timerCustomOpen ? " open" : "");
      $("timerCustomChevron").className = "moderation-chevron" + (timerCustomOpen ? " open" : "");
    }

    // ===================== TIMER =====================
    function timerUpdateDisplay() {
      const mm = Math.floor(timerSeconds / 60);
      const ss = timerSeconds % 60;
      $("timerPreview").textContent = `${pad2(mm)}:${pad2(ss)}`;
      $("timerDigitM10").textContent = Math.floor(mm / 10);
      $("timerDigitM1").textContent = mm % 10;
      $("timerDigitS10").textContent = Math.floor(ss / 10);
      $("timerDigitS1").textContent = ss % 10;
    }

    function timerSetMode(mode) {
      if (!connected) { flash("timer", "‚ùå Connectez-vous", "error"); return; }
      timerMode = mode;
      document.querySelectorAll(".timer-mode-btn").forEach(btn => btn.classList.toggle("active", btn.dataset.mode === mode));
      socket.emit("control:timer_set_mode", { room: currentRoom, mode });
      if (mode === "chrono") { timerSeconds = 0; timerUpdateDisplay(); }
    }

    function timerPreset(seconds) {
      if (!connected) { flash("timer", "‚ùå Connectez-vous", "error"); return; }
      timerSeconds = Math.max(0, Math.min(seconds, 99 * 60 + 59));
      timerUpdateDisplay();
      socket.emit("control:timer_set_time", { room: currentRoom, seconds: timerSeconds });
    }

    function timerAdjust(delta) {
      if (!connected) { flash("timer", "‚ùå Connectez-vous", "error"); return; }
      timerSeconds = Math.max(0, Math.min(timerSeconds + delta, 99 * 60 + 59));
      timerUpdateDisplay();
      socket.emit("control:timer_increment_time", { room: currentRoom, seconds: delta });
    }

    function timerStart() {
      if (!connected) { flash("timer", "‚ùå Connectez-vous", "error"); return; }
      socket.emit("control:timer_start", { room: currentRoom });
      timerRunning = true;
    }

    function timerPause() {
      if (!connected) { flash("timer", "‚ùå Connectez-vous", "error"); return; }
      socket.emit("control:timer_toggle_pause", { room: currentRoom });
      timerRunning = false;
    }

    function timerReset() {
      if (!connected) { flash("timer", "‚ùå Connectez-vous", "error"); return; }
      socket.emit("control:timer_reset", { room: currentRoom });
      timerRunning = false;
      timerSeconds = 60;
      timerUpdateDisplay();
    }

    // ===================== MATCH =====================
    function matchAdjustScore(team, delta) {
      if (!connected) { flash("match", "‚ùå Connectez-vous", "error"); return; }
      if (team === "A") { matchScoreA = Math.max(0, matchScoreA + delta); $("matchScoreA").textContent = matchScoreA; }
      else { matchScoreB = Math.max(0, matchScoreB + delta); $("matchScoreB").textContent = matchScoreB; }
      socket.emit("control:match_adjust_score", { room: currentRoom, team, delta });
    }

    function matchReset() {
      if (!connected) { flash("match", "‚ùå Connectez-vous", "error"); return; }
      matchScoreA = 0; matchScoreB = 0;
      $("matchScoreA").textContent = "0"; $("matchScoreB").textContent = "0";
      socket.emit("control:match_reset", { room: currentRoom });
    }

    // ===================== S√âCURIT√â ‚Äî √âCHAPPEMENT HTML/JS =====================
    function escHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function escJs(str) {
      return String(str).replace(/\\/g, "\\\\").replace(/'/g, "\\'");
    }

    // ===================== INIT =====================
    $("btnConnect").onclick = connect;

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("room")) $("roomId").value = urlParams.get("room");
    if (urlParams.get("key")) $("roomKey").value = urlParams.get("key");

    timerUpdateDisplay();
  </script>
</body>
</html>
