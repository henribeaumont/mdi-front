<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>MDI ‚Ä¢ Mon Catalogue Client</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #f8fafc; --panel: #ffffff; --text: #0f172a; --accent: #3b82f6; --danger: #ef4444; }
    body { background: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; display: none; }
    .login-box { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 15px; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
    label { display: block; font-weight: 600; font-size: 13px; color: #64748b; margin-bottom: 5px; text-align: left; }
    button { background: var(--accent); color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; font-weight: bold; cursor: pointer; font-family: 'Montserrat', sans-serif; }
    button:hover { opacity: 0.9; }
    .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .q-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .q-item:last-child { border-bottom: none; }
    .btn-group { display: flex; gap: 8px; }
    .btn-small { width: auto; padding: 8px 12px; font-size: 13px; }
  </style>
</head>
<body>

<div id="login" class="login-box">
  <h2>üëã Acc√®s Catalogue</h2>
  <label>ID Client (Room ID)</label><input id="roomId">
  <label>Cl√© Secr√®te</label><input id="roomKey" type="password">
  <button onclick="login()">Se connecter</button>
</div>

<div id="app" class="container">
  <div style="display:flex; justify-content:space-between; margin-bottom:20px">
    <h2>Mes Questions</h2>
    <button onclick="logout()" style="width:auto; background:#94a3b8">D√©connexion</button>
  </div>

  <div class="card">
    <h3 id="formTitle">Ajouter une question</h3>
    <form id="formQ">
      <input type="hidden" id="editMode" value="false">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <div><label>Code (ex: Q1)</label><input id="q_key" required></div>
        <div><label>Type</label><select id="q_type"><option value="quiz">Quiz</option><option value="poll">Sondage</option></select></div>
      </div>
      <label>Question</label><textarea id="q_prompt" required></textarea>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <div><label>R√©ponse A</label><input id="q_a" required></div>
        <div><label>R√©ponse B</label><input id="q_b" required></div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <div><label>R√©ponse C</label><input id="q_c"></div>
        <div><label>R√©ponse D</label><input id="q_d"></div>
      </div>
      <label>Bonne R√©ponse (Quiz)</label>
      <select id="q_correct"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button type="submit" style="flex:1">üíæ Enregistrer</button>
        <button type="button" onclick="cancelEdit()" id="btnCancel" style="flex:1; background:#94a3b8; display:none;">Annuler</button>
      </div>
    </form>
  </div>
  
  <div class="card">
    <h3>Liste des Questions</h3>
    <div id="list">Chargement...</div>
  </div>
</div>

<script>
const API_BASE = "https://magic-digital-impact-live.onrender.com/api/client";
const store = localStorage;

if(store.getItem("mdi_id")) login(true);

async function login(auto=false) {
  const id = auto ? store.getItem("mdi_id") : document.getElementById("roomId").value.trim();
  const key = auto ? store.getItem("mdi_key") : document.getElementById("roomKey").value.trim();
  
  try {
    const res = await fetch(API_BASE + "/questions", { 
      headers: { "x-room-id": id, "x-room-key": key } 
    });
    const json = await res.json();
    if(json.ok) {
      store.setItem("mdi_id", id);
      store.setItem("mdi_key", key);
      document.getElementById("login").style.display = "none";
      document.getElementById("app").style.display = "block";
      renderList(json.questions);
    } else {
      if(!auto) alert("Identifiants incorrects.");
      logout();
    }
  } catch(e) { console.error(e); }
}

function logout() { store.clear(); location.reload(); }

document.getElementById("formQ").onsubmit = async (e) => {
  e.preventDefault();
  
  const body = {
    question_key: document.getElementById("q_key").value,
    type: document.getElementById("q_type").value,
    order_index: Date.now(),
    prompt: document.getElementById("q_prompt").value,
    option_a: document.getElementById("q_a").value,
    option_b: document.getElementById("q_b").value,
    option_c: document.getElementById("q_c").value,
    option_d: document.getElementById("q_d").value,
    correct_option: document.getElementById("q_correct").value,
    enabled: true
  };
  
  const res = await fetch(API_BASE + "/save-question", {
    method: "POST",
    headers: { 
      "Content-Type": "application/json", 
      "x-room-id": store.getItem("mdi_id"), 
      "x-room-key": store.getItem("mdi_key") 
    },
    body: JSON.stringify(body)
  });
  
  if((await res.json()).ok) {
    cancelEdit();
    login(true);
  }
};

function renderList(list) {
  document.getElementById("list").innerHTML = list.map(q => `
    <div class="q-item">
      <span><b>${q.question_key}</b> : ${q.prompt}</span>
      <div class="btn-group">
        <button onclick="editQ('${q.question_key}')" class="btn-small" style="background:#10b981">‚úèÔ∏è Modifier</button>
        <button onclick="delQ('${q.question_key}')" class="btn-small" style="background:#ef4444">üóëÔ∏è Supprimer</button>
      </div>
    </div>
  `).join('');
}

window.editQ = async (qid) => {
  // R√©cup√©rer la question compl√®te
  const res = await fetch(API_BASE + "/questions", { 
    headers: { 
      "x-room-id": store.getItem("mdi_id"), 
      "x-room-key": store.getItem("mdi_key") 
    } 
  });
  const json = await res.json();
  const question = json.questions.find(q => q.question_key === qid);
  
  if(question) {
    // Remplir le formulaire
    document.getElementById("q_key").value = question.question_key;
    document.getElementById("q_type").value = question.type;
    document.getElementById("q_prompt").value = question.prompt;
    document.getElementById("q_a").value = question.option_a;
    document.getElementById("q_b").value = question.option_b;
    document.getElementById("q_c").value = question.option_c || "";
    document.getElementById("q_d").value = question.option_d || "";
    document.getElementById("q_correct").value = question.correct_option;
    
    // Passer en mode √©dition
    document.getElementById("editMode").value = "true";
    document.getElementById("formTitle").innerText = "‚úèÔ∏è Modifier la question";
    document.getElementById("btnCancel").style.display = "block";
    
    // Scroll vers le formulaire
    document.getElementById("formQ").scrollIntoView({ behavior: 'smooth' });
  }
};

function cancelEdit() {
  document.getElementById("formQ").reset();
  document.getElementById("editMode").value = "false";
  document.getElementById("formTitle").innerText = "Ajouter une question";
  document.getElementById("btnCancel").style.display = "none";
}

async function delQ(qid) {
  if(confirm("Supprimer cette question ?")) {
    await fetch(API_BASE + "/delete-question", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json", 
        "x-room-id": store.getItem("mdi_id"), 
        "x-room-key": store.getItem("mdi_key") 
      },
      body: JSON.stringify({ question_key: qid })
    });
    login(true);
  }
}
</script>
</body>
</html>
